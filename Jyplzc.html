<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é‚®ç®±æ‰¹é‡æ³¨å†Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f5fb;
      --card-bg: #ffffff;
      --border: #e2e4f0;
      --border-soft: #edf0fb;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.08);
      --danger: #ef4444;
      --success: #16a34a;
      --text: #111827;
      --muted: #6b7280;
      --radius: 12px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.06);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eef1ff 0, #f4f5fb 40%, #f6f7fc 100%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 12px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.02em;
    }

    .title-group small {
      display: block;
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .version-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.06);
      color: #1d4ed8;
      font-size: 11px;
      margin-left: 6px;
    }

    .stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .stat-item {
      min-width: 90px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(226, 232, 240, 0.7);
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .stat-item span.value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .badge {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    .badge-gray {
      background: #f3f4f6;
      color: #4b5563;
      border-color: #e5e7eb;
    }

    .badge-green {
      background: rgba(22, 163, 74, 0.08);
      color: #15803d;
      border-color: rgba(22, 163, 74, 0.35);
    }

    .badge-red {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.35);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.8fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .stats {
        justify-content: flex-start;
      }
    }

    @media (max-width: 600px) {
      .app {
        margin: 16px auto 24px;
        padding: 0 10px;
      }
      .title-group h1 {
        font-size: 20px;
      }
      .card {
        padding: 12px 12px 10px;
      }
      .stats {
        width: 100%;
      }
      .stat-item {
        flex: 1 1 calc(50% - 5px);
      }
      table {
        font-size: 11px;
      }
      th,
      td {
        padding: 4px 4px;
      }
    }

    @media (max-width: 480px) {
      .app-header {
        align-items: stretch;
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .stat-item {
        flex: 1 1 100%;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 6px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .card-header-right {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .form-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
    }

    .form-row label span.req {
      color: #ef4444;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color var(--transition-fast), background var(--transition-fast),
        box-shadow var(--transition-fast);
      width: 100%;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(37, 99, 235, 0.7);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.08);
    }

    input[readonly] {
      background: #f3f4f6;
      color: #6b7280;
    }

    .input-inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-inline input {
      flex: 1;
    }

    /* è§„å¾‹æ¨¡å¼ï¼šä¸‹æ‹‰æ¡†çª„ä¸€ç‚¹ï¼Œæ•°å­—è¾“å…¥æ¡†æ›´å®½ï¼Œæ–¹ä¾¿æ‰‹æœºè¾“å…¥æŸ¥çœ‹ */
    #rowPatternConfig .input-inline select {
      flex: 0 0 110px;
      max-width: 120px;
    }
    #rowPatternConfig .input-inline input {
      flex: 1 1 auto;
      min-width: 0;
    }

    .btn,
    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, background 0.15s ease-out,
        border-color 0.15s ease-out, color 0.15s ease-out;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.4);
      background: #1d4ed8;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border-radius: 999px;
      padding-inline: 10px;
    }

    .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.1);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
      border-radius: 999px;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 7px;
      font-size: 12px;
      background: transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: background var(--transition-fast), color var(--transition-fast),
        transform 0.1s ease-out;
    }

    .icon-btn:hover {
      background: rgba(148, 163, 184, 0.12);
      color: var(--text);
      transform: translateY(-0.5px);
    }

    /* è¡¨æ ¼ä¸­å°çœ¼ç›ã€å°å¤åˆ¶æŒ‰é’® */
    .icon-btn-mini {
      padding: 1px 4px;
      font-size: 11px;
      margin-left: 2px;
    }

    .token-display {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .token-input {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
    }

    .pill-group {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .pill {
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(148, 163, 184, 0.1);
      font-size: 11px;
      color: var(--muted);
    }

    .pill-strong {
      background: rgba(37, 99, 235, 0.08);
      color: #1d4ed8;
    }

    .section-title-inline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      color: #4b5563;
      transition: background var(--transition-fast), border-color var(--transition-fast),
        color var(--transition-fast);
    }

    .chip input {
      margin: 0;
    }

    .chip.active {
      border-color: rgba(37, 99, 235, 0.7);
      background: rgba(37, 99, 235, 0.06);
      color: #1d4ed8;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .muted-sm {
      color: var(--muted);
      font-size: 11px;
    }

    .progress-wrap {
      margin-top: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      transition: width 0.2s ease-out;
    }

    .progress-text {
      margin-top: 4px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid #f2f4f7;
    }

    th {
      font-weight: 500;
      color: #6b7280;
      white-space: nowrap;
    }

    tr:hover td {
      background: #f9fafb;
    }

    .table-wrapper {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 600px) {
      .table-wrapper table {
        min-width: 600px;
      }
    }

    .status-tag {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-ok {
      background: rgba(22, 163, 74, 0.08);
      color: #15803d;
      border-color: rgba(22, 163, 74, 0.35);
    }

    .status-fail {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.35);
    }

    .status-pending {
      background: rgba(148, 163, 184, 0.1);
      color: #4b5563;
      border-color: rgba(148, 163, 184, 0.35);
    }

    .log-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 220px;
      overflow: auto;
      font-size: 12px;
    }

    .log-item {
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .log-item span.time {
      color: #9ca3af;
      margin-right: 6px;
    }

    .log-item span.tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
      margin-right: 6px;
    }

    .tag-system {
      background: #e5e7eb;
      color: #4b5563;
    }

    .tag-success {
      background: rgba(22, 163, 74, 0.18);
      color: #166534;
    }

    .tag-error {
      background: rgba(239, 68, 68, 0.2);
      color: #b91c1c;
    }

    .help-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .help-list li {
      padding: 2px 0;
    }

    .pill-filter-group {
      display: inline-flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .pill-filter {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast),
        color var(--transition-fast);
    }

    .pill-filter.active {
      border-color: rgba(37, 99, 235, 0.7);
      background: rgba(37, 99, 235, 0.06);
      color: #1d4ed8;
    }

    .toast {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #111827;
      color: white;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transform: translateY(-10px);
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      z-index: 999;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .toast-success {
      background: #16a34a;
    }

    .toast-error {
      background: #dc2626;
    }

    .toast-info {
      background: #111827;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out;
      z-index: 995;
    }

    .overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .dialog {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-out, transform 0.15s ease-out;
      z-index: 996;
    }

    .dialog.show {
      pointer-events: auto;
      opacity: 1;
    }

    .dialog-content {
      width: min(420px, 92vw);
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 16px 16px 14px;
      transform: translateY(8px);
    }

    .dialog.show .dialog-content {
      transform: translateY(0);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .dialog-title {
      font-size: 15px;
      font-weight: 600;
    }

    .dialog-body {
      max-height: 320px;
      overflow: auto;
      font-size: 13px;
    }

    .dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 12px;
    }

    .token-history-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .token-history-item {
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      font-size: 12px;
    }

    .token-history-meta {
      color: #6b7280;
      font-size: 11px;
    }

    .token-history-token {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
      color: #4b5563;
      word-break: break-all;
    }

    .badge-outline {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #6b7280;
    }

    .email-detail {
      font-size: 12px;
    }

    .email-detail-row {
      margin-bottom: 4px;
    }

    .email-detail-row span.label {
      display: inline-block;
      width: 54px;
      color: #6b7280;
    }

    .email-body-viewer {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 8px;
      height: 180px;
      overflow: hidden;
    }

    .email-body-viewer iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .badge-type {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      color: #1d4ed8;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-group">
        <h1>é‚®ç®±æ‰¹é‡æ³¨å†Œ</h1>
        <small
          >æç®€æ§åˆ¶å°-beimuæä¾›<span class="version-tag">UI v1.0</span></small
        >
      </div>
      <div class="stats">
        <div class="stat-item">
          <span>ä»Šæ—¥æ³¨å†Œ</span>
          <span class="value" id="statToday">0</span>
        </div>
        <div class="stat-item">
          <span>æ€»æ³¨å†Œæ•°</span>
          <span class="value" id="statTotal">0</span>
        </div>
        <div class="stat-item">
          <span>æˆåŠŸç‡</span>
          <span class="value" id="statRate">0%</span>
        </div>
        <div class="stat-item">
          <span>API çŠ¶æ€</span>
          <span class="value">
            <span id="apiStatus" class="badge badge-gray">å¾…æ£€æµ‹</span>
            <button
              type="button"
              class="icon-btn"
              id="btnCheckApi"
              title="æ£€æµ‹ API è”é€šæ€§"
            >
              âŸ³
            </button>
          </span>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- å·¦ä¾§ï¼šAPI + æ³¨å†Œé…ç½® + è¿›åº¦ -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">API é…ç½®</div>
            <div class="card-subtitle">åªéœ€é…ç½®ä¸€æ¬¡ï¼Œä»¤ç‰Œä¸åŸºç¡€ä¿¡æ¯ä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨</div>
          </div>
          <div class="card-header-right muted-sm">
            <span>Token å•ä¾‹ Â· åå°ç»Ÿä¸€è®¤è¯</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label>API åŸŸå<span class="req">*</span></label>
            <input
              type="text"
              id="inputApiBase"
              placeholder="ä¾‹å¦‚ï¼šhttps://mail.example.com"
            />
          </div>
          <div class="form-row">
            <label>Access Token</label>
            <div class="token-display">
              <input
                type="password"
                id="inputToken"
                class="token-input"
                placeholder="å°šæœªç”Ÿæˆæˆ–ç²˜è´´"
              />
              <button
                type="button"
                class="icon-btn"
                id="btnToggleToken"
                title="æ˜¾ç¤º/éšè—"
              >
                ğŸ‘
              </button>
              <button
                type="button"
                class="icon-btn"
                id="btnClearToken"
                title="æ¸…é™¤"
              >
                âœ•
              </button>
            </div>
            <div class="muted-sm">
              å¯ç›´æ¥ç²˜è´´å·²æœ‰ Tokenï¼Œæˆ–é€šè¿‡ä¸‹æ–¹ç®¡ç†å‘˜è´¦å·ç”Ÿæˆ
            </div>
          </div>

          <div class="form-row">
            <label>ç®¡ç†å‘˜é‚®ç®±<span class="req">*</span></label>
            <input
              type="text"
              id="inputAdminEmail"
              placeholder="ç”¨äºç”Ÿæˆ Token çš„ç®¡ç†å‘˜é‚®ç®±"
            />
          </div>
          <div class="form-row">
            <label>ç®¡ç†å‘˜å¯†ç <span class="req">*</span></label>
            <input
              type="password"
              id="inputAdminPassword"
              placeholder="ä¸ä¼šä¸Šä¼ ä¿å­˜ï¼Œä»…ç”¨æ¥å‘ API è¯·æ±‚ Token"
            />
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 10px;
          "
        >
          <div style="display: flex; gap: 6px">
            <button class="btn btn-ghost btn-sm" id="btnTokenHistory">
              Token å†å²
            </button>
            <button class="btn btn-primary btn-sm" id="btnGenToken">
              ç”Ÿæˆ Token
            </button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">æ³¨å†Œè®¾ç½®</div>
            <div class="card-subtitle">
              æ ¹æ®è§„åˆ™è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·å + å¯†ç ï¼Œå•æ¬¡æœ€å¤š 100 ä¸ªè´¦å·
            </div>
          </div>
          <div class="card-header-right">
            <span class="pill pill-strong">æ‰¹é‡åˆ›å»º</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label>æ³¨å†Œæ•°é‡<span class="req">*</span></label>
            <input
              type="number"
              id="inputCount"
              min="1"
              max="100"
              value="10"
            />
            <div class="muted-sm">æ¨èå•æ¬¡ &lt;= 100ï¼Œé¿å…æ¥å£å‹åŠ›</div>
          </div>
          <div class="form-row">
            <label>é‚®ç®±åŸŸå<span class="req">*</span></label>
            <input
              type="text"
              id="inputDomain"
              placeholder="ä¾‹å¦‚ï¼šexample.com æˆ– @example.com"
            />
            <div class="muted-sm">æ— éœ€å¡«å†™ç”¨æˆ·åéƒ¨åˆ†ï¼Œä»…å¡«å†™åŸŸåå³å¯</div>
          </div>
        </div>

        <div class="section-title-inline">
          <span>ç”¨æˆ·åé…ç½®</span>
          <span class="muted-sm" id="usernamePreview">æ€»é•¿åº¦é¢„è§ˆï¼š0 ä½</span>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label>ç”¨æˆ·åå‰ç¼€</label>
            <input
              type="text"
              id="inputUsernamePrefix"
              placeholder="å¯é€‰ï¼Œç•™ç©ºåˆ™å®Œå…¨éšæœº"
            />
          </div>
          <div class="form-row">
            <label>åŸºç¡€é•¿åº¦<span class="req">*</span></label>
            <input
              type="number"
              id="inputBaseLength"
              min="1"
              max="20"
              value="6"
            />
          </div>
          <div class="form-row">
            <label>ç”Ÿæˆæ¨¡å¼<span class="req">*</span></label>
            <div class="chip-group" id="usernameModeGroup">
              <label class="chip active"
                ><input
                  type="radio"
                  name="usernameMode"
                  value="random"
                  checked
                />å®Œå…¨éšæœº</label
              >
              <label class="chip"
                ><input type="radio" name="usernameMode" value="letter-digit" />å­—æ¯+æ•°å­—</label
              >
              <label class="chip"
                ><input type="radio" name="usernameMode" value="digit-letter" />æ•°å­—+å­—æ¯</label
              >
            </div>
          </div>
          <div class="form-row">
            <label>æ•°å­—éƒ¨åˆ†</label>
            <div class="chip-group" id="numberModeGroup">
              <label class="chip active"
                ><input
                  type="radio"
                  name="numberMode"
                  value="none"
                  checked
                />æ— æ•°å­—</label
              >
              <label class="chip"
                ><input type="radio" name="numberMode" value="random" />éšæœºæ•°å­—</label
              >
              <label class="chip"
                ><input type="radio" name="numberMode" value="pattern" />è§„å¾‹æ¨¡å¼</label
              >
            </div>
          </div>
          <div class="form-row" id="rowNumberLength">
            <label>æ•°å­—é•¿åº¦</label>
            <input
              type="number"
              id="inputNumberLength"
              min="1"
              max="10"
              value="3"
            />
          </div>
          <div class="form-row" id="rowPatternConfig" style="display: none">
            <label>è§„å¾‹æ¨¡å¼è®¾ç½®</label>
            <div class="input-inline">
              <select id="selectPatternType">
                <option value="student">å­¦å·æ¨¡å¼</option>
                <option value="date">æ—¥æœŸæ¨¡å¼</option>
              </select>
              <input
                type="number"
                id="inputPatternStart"
                inputmode="numeric"
                pattern="[0-9]*"
                placeholder="èµ·å§‹å€¼ï¼ˆæ—¥æœŸæ¨¡å¼å¯ç•™ç©ºï¼‰"
              />
            </div>
          </div>
          <div class="form-row">
            <label>å­—ç¬¦ç±»å‹ï¼ˆç”¨æˆ·åï¼‰</label>
            <div class="chip-group" id="usernameCharsetGroup">
              <label class="chip active"
                ><input type="checkbox" value="upper" checked />å¤§å†™</label
              >
              <label class="chip active"
                ><input type="checkbox" value="lower" checked />å°å†™</label
              >
              <label class="chip active"
                ><input type="checkbox" value="digit" checked />æ•°å­—</label
              >
              <label class="chip"
                ><input type="checkbox" value="symbol" />ç¬¦å·</label
              >
            </div>
          </div>
        </div>

        <div class="section-title-inline" style="margin-top: 8px">
          <span>å¯†ç é…ç½®</span>
          <span class="muted-sm">å¯†ç åªåœ¨æœ¬é¡µé¢å±•ç¤º & å¯¼å‡ºï¼Œä¸ä¼šå›ä¼ åˆ°æœåŠ¡å™¨</span>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label>å¯†ç é•¿åº¦</label>
            <div class="chip-group" id="passwordLengthGroup">
              <label class="chip"
                ><input type="radio" name="passwordLength" value="8" />8</label
              >
              <label class="chip active"
                ><input
                  type="radio"
                  name="passwordLength"
                  value="10"
                  checked
                />10</label
              >
              <label class="chip"
                ><input type="radio" name="passwordLength" value="12" />12</label
              >
              <label class="chip"
                ><input type="radio" name="passwordLength" value="16" />16</label
              >
            </div>
          </div>
          <div class="form-row">
            <label>å¯†ç å­—ç¬¦ç±»å‹</label>
            <div class="chip-group" id="passwordCharsetGroup">
              <label class="chip active"
                ><input type="checkbox" value="upper" checked />å¤§å†™</label
              >
              <label class="chip active"
                ><input type="checkbox" value="lower" checked />å°å†™</label
              >
              <label class="chip active"
                ><input type="checkbox" value="digit" checked />æ•°å­—</label
              >
              <label class="chip"
                ><input type="checkbox" value="symbol" />ç¬¦å·</label
              >
            </div>
          </div>
          <div class="form-row">
            <label>æƒé™è§’è‰²</label>
            <input
              type="text"
              id="inputRoleName"
              placeholder="å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤æƒé™èº«ä»½"
            />
          </div>
          <div class="form-row" style="align-self: flex-end">
            <div style="display: flex; justify-content: flex-end; gap: 8px">
              <button class="btn btn-ghost btn-sm" id="btnResetSettings">
                é‡ç½®è®¾ç½®
              </button>
              <button class="btn btn-primary btn-sm" id="btnStartRegister">
                å¼€å§‹æ³¨å†Œ
              </button>
            </div>
          </div>
        </div>

        <div class="progress-wrap">
          <div class="section-title-inline">
            <span>æ³¨å†Œè¿›åº¦</span>
            <span class="muted-sm" id="progressText">0 / 0 Â· 0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-inner" id="progressBar"></div>
          </div>
          <div class="progress-text">
            <span id="progressStatus">ç­‰å¾…å¼€å§‹</span>
            <span class="muted-sm">å•ä¸ªè´¦å·é€ä¸€è°ƒç”¨æ¥å£</span>
          </div>
        </div>
      </section>

      <!-- å³ä¾§ï¼šç»“æœ / é‚®ä»¶æŸ¥è¯¢ / æ—¥å¿— -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">æ³¨å†Œç»“æœ</div>
            <div class="card-subtitle">ä¿å­˜æ‰€æœ‰æœ¬åœ°æ³¨å†Œè®°å½•ï¼Œå¯å¯¼å‡ºä¸º CSV</div>
          </div>
          <div class="card-header-right">
            <div class="pill-filter-group" id="resultFilterGroup">
              <button class="pill-filter active" data-filter="all">å…¨éƒ¨</button>
              <button class="pill-filter" data-filter="success">æˆåŠŸ</button>
              <button class="pill-filter" data-filter="fail">å¤±è´¥</button>
            </div>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 6px">
          <div class="muted-sm">
            å•æ¬¡å¯¼å‡ºåŒ…å«ï¼šé‚®ç®±ã€å¯†ç ã€çŠ¶æ€ã€æ—¶é—´ã€å¤‡æ³¨ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
          </div>
          <div style="display: flex; gap: 6px">
            <button class="btn btn-ghost btn-sm" id="btnExportRecords">
              å¯¼å‡º CSV
            </button>
            <button class="btn btn-danger btn-sm" id="btnClearRecords">
              æ¸…ç©ºè®°å½•
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width: 40px">#</th>
                <th>é‚®ç®±åœ°å€</th>
                <th>å¯†ç </th>
                <th style="width: 80px">çŠ¶æ€</th>
                <th style="width: 130px">æ—¶é—´</th>
                <th>å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody id="recordTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 18px 8px">
                  <span class="muted">æš‚æ— æ³¨å†Œè®°å½•</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">é‚®ä»¶æŸ¥è¯¢</div>
            <div class="card-subtitle">æŒ‰æ”¶ä»¶äºº / å‘ä»¶äºº / ä¸»é¢˜ç­›é€‰ï¼ŒæŸ¥çœ‹æ”¶å‘é‚®ä»¶æ¦‚è§ˆ</div>
          </div>
          <div class="card-header-right muted-sm">
            éœ€è¦æœ‰æ•ˆ Token ä¸ API åŸŸå
          </div>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label>æ”¶ä»¶äººé‚®ç®±</label>
            <input
              type="text"
              id="inputToEmail"
              placeholder="æ”¯æŒæ¨¡ç³Šï¼šå¦‚ admin% æˆ– %@example.com"
            />
          </div>
          <div class="form-row">
            <label>å‘ä»¶äººé‚®ç®±</label>
            <input
              type="text"
              id="inputSendEmail"
              placeholder="æ”¯æŒæ¨¡ç³Š"
            />
          </div>
          <div class="form-row">
            <label>ä¸»é¢˜å…³é”®å­—</label>
            <input
              type="text"
              id="inputSubject"
              placeholder="æ”¯æŒæ¨¡ç³ŠåŒ¹é…"
            />
          </div>
          <div class="form-row">
            <label>é‚®ä»¶ç±»å‹</label>
            <select id="selectEmailType">
              <option value="">å…¨éƒ¨</option>
              <option value="0">æ”¶ä»¶</option>
              <option value="1">å‘ä»¶</option>
            </select>
          </div>
          <div class="form-row">
            <label>æ˜¯å¦åˆ é™¤</label>
            <select id="selectIsDel">
              <option value="">å…¨éƒ¨</option>
              <option value="0">æ­£å¸¸</option>
              <option value="2">å·²åˆ é™¤</option>
            </select>
          </div>
          <div class="form-row">
            <label>æ’åº / åˆ†é¡µ</label>
            <div class="input-inline">
              <select id="selectTimeSort">
                <option value="desc">æœ€æ–°åœ¨å‰</option>
                <option value="asc">æœ€æ—§åœ¨å‰</option>
              </select>
              <input
                type="number"
                id="inputPageNum"
                min="1"
                value="1"
                style="max-width: 70px"
              />
              <input
                type="number"
                id="inputPageSize"
                min="1"
                max="100"
                value="20"
                style="max-width: 70px"
              />
            </div>
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
          "
        >
          <div class="muted-sm">
            æç¤ºï¼šæ”¯æŒä½¿ç”¨ % è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼ˆå¦‚ <code>admin%</code> / <code>%@example.com</code>ï¼‰
          </div>
          <button class="btn btn-primary btn-sm" id="btnQueryEmail">
            æŸ¥è¯¢é‚®ä»¶
          </button>
        </div>

        <div
          class="table-wrapper"
          style="margin-top: 4px"
        >
          <table>
            <thead>
              <tr>
                <th style="width: 40px">#</th>
                <th style="width: 72px">ç±»å‹</th>
                <th>å‘ä»¶äºº</th>
                <th>æ”¶ä»¶äºº</th>
                <th>ä¸»é¢˜</th>
                <th style="width: 130px">æ—¶é—´</th>
                <th style="width: 64px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="emailTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 16px 8px">
                  <span class="muted">å°šæœªæŸ¥è¯¢ï¼Œå¡«å†™æ¡ä»¶åç‚¹å‡»ã€ŒæŸ¥è¯¢é‚®ä»¶ã€</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ç³»ç»Ÿæ—¥å¿—</div>
            <div class="card-subtitle">ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜</div>
          </div>
          <div class="card-header-right">
            <span class="badge-outline" id="logCountBadge">0 æ¡</span>
          </div>
        </div>
        <ul class="log-list" id="logList"></ul>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
          "
        >
          <div class="muted-sm">
            è‹¥ Token å¤±æ•ˆ / API æŠ¥é”™ï¼Œå¯ä¼˜å…ˆæŸ¥çœ‹è¿™é‡Œçš„æ—¶é—´ä¸é”™è¯¯æç¤º
          </div>
          <button class="btn btn-ghost btn-sm" id="btnClearLog">
            æ¸…ç©ºæ—¥å¿—
          </button>
        </div>

        <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 10px 0" />

        <div class="card-subtitle" style="margin-bottom: 6px">å¿«é€Ÿä½¿ç”¨æç¤º</div>
        <ul class="help-list">
          <li>1. å…ˆåœ¨å·¦ä¸Šé…ç½® API åŸŸåã€ç®¡ç†å‘˜è´¦å·ï¼Œç‚¹å‡»ã€Œç”Ÿæˆ Tokenã€ã€‚</li>
          <li>2. è®¾ç½®æ³¨å†Œæ•°é‡ã€åŸŸåä¸ç”¨æˆ·åè§„åˆ™ï¼Œç¡®è®¤å¯†ç é•¿åº¦ã€‚</li>
          <li>3. ç‚¹å‡»ã€Œå¼€å§‹æ³¨å†Œã€ï¼Œç­‰å¾…å³ä¸Šè¿›åº¦æ¡è·‘å®Œå³å¯ã€‚</li>
          <li>4. ç»“æœæ”¯æŒè¿‡æ»¤æˆåŠŸ / å¤±è´¥å¹¶å¯¼å‡º CSVã€‚</li>
          <li>
            5.
            å®é™…ç”Ÿäº§æ—¶ï¼Œé¿å…åœ¨å…¬å…±è®¾å¤‡é•¿æ—¶é—´ä¿å­˜æ•æ„Ÿä¿¡æ¯ã€‚
          </li>
        </ul>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="overlay"></div>

  <!-- Token å†å²å¼¹çª— -->
  <div class="dialog" id="dialogTokenHistory">
    <div class="dialog-content">
      <div class="dialog-header">
        <div class="dialog-title">Token å†å²</div>
        <button class="icon-btn" data-dialog-close="dialogTokenHistory">
          âœ•
        </button>
      </div>
      <div class="dialog-body">
        <p class="muted-sm" style="margin-top: 0">
          ä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨æœ¬åœ°ï¼Œå»ºè®®ä¸è¦åœ¨å…¬å…±è®¾å¤‡é•¿æœŸä¿ç•™ã€‚
        </p>
        <ul class="token-history-list" id="tokenHistoryList"></ul>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-ghost btn-sm" data-dialog-close="dialogTokenHistory">
          å…³é—­
        </button>
        <button class="btn btn-danger btn-sm" id="btnClearTokenHistory">
          æ¸…ç©ºå†å²
        </button>
      </div>
    </div>
  </div>

  <!-- æ¸…ç©ºè®°å½•ç¡®è®¤ -->
  <div class="dialog" id="dialogConfirmClear">
    <div class="dialog-content">
      <div class="dialog-header">
        <div class="dialog-title">ç¡®è®¤æ¸…ç©ºæ³¨å†Œè®°å½•ï¼Ÿ</div>
      </div>
      <div class="dialog-body">
        <p class="muted-sm">
          æ­¤æ“ä½œä»…æ¸…ç†æœ¬åœ°è®°å½•ï¼Œä¸ä¼šå½±å“å·²åˆ›å»ºçš„é‚®ç®±è´¦å·ã€‚æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ç¡®è®¤ã€‚
        </p>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-ghost btn-sm" data-dialog-close="dialogConfirmClear">
          å–æ¶ˆ
        </button>
        <button class="btn btn-danger btn-sm" id="btnConfirmClearRecords">
          ç¡®è®¤æ¸…ç©º
        </button>
      </div>
    </div>
  </div>

  <!-- é‚®ä»¶è¯¦æƒ…å¼¹çª— -->
  <div class="dialog" id="dialogEmailDetail">
    <div class="dialog-content">
      <div class="dialog-header">
        <div class="dialog-title">é‚®ä»¶è¯¦æƒ…</div>
        <button class="icon-btn" data-dialog-close="dialogEmailDetail">âœ•</button>
      </div>
      <div class="dialog-body">
        <div class="email-detail" id="emailDetailContent"></div>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-ghost btn-sm" data-dialog-close="dialogEmailDetail">
          å…³é—­
        </button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const STORAGE_KEY = "skyBatchReg_v1";
      const TODAY_KEY = "skyBatchReg_today";

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const state = {
        apiBase: "",
        token: "",
        adminEmail: "",
        stats: {
          today: 0,
          total: 0,
          success: 0,
          fail: 0,
        },
        tokenHistory: [],
        records: [],
      };

      let currentFilter = "all";
      let toastTimer = null;
      let running = false;
      let emailCache = [];

      const htmlEsc = (str) =>
        (str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      function todayStr() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${dd}`;
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const saved = JSON.parse(raw);
            if (saved.apiBase) state.apiBase = saved.apiBase;
            if (saved.token) state.token = saved.token;
            if (saved.adminEmail) state.adminEmail = saved.adminEmail;
            if (saved.stats) Object.assign(state.stats, saved.stats);
            if (Array.isArray(saved.tokenHistory))
              state.tokenHistory = saved.tokenHistory;
            if (Array.isArray(saved.records)) state.records = saved.records;
          }
        } catch (e) {
          console.error(e);
        }

        const t = todayStr();
        const last = localStorage.getItem(TODAY_KEY);
        if (last !== t) {
          state.stats.today = 0;
          localStorage.setItem(TODAY_KEY, t);
        }

        $("#inputApiBase").value = state.apiBase || "";
        $("#inputToken").value = state.token || "";
        $("#inputAdminEmail").value = state.adminEmail || "";
        updateStats();
        renderRecords();
        addLog("ç³»ç»Ÿå·²å¯åŠ¨ï¼Œå‡†å¤‡å°±ç»ª", "system");
        refreshTokenHistoryUI();
        updateApiStatus();
        syncNumberModeUI();
        updateUsernamePreview();
      }

      function saveState() {
        const toSave = {
          apiBase: state.apiBase,
          token: state.token,
          adminEmail: state.adminEmail,
          stats: state.stats,
          tokenHistory: state.tokenHistory,
          records: state.records,
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        } catch (e) {
          console.error(e);
        }
      }

      function showToast(type, msg) {
        const toast = $("#toast");
        toast.className = "toast";
        if (type === "success") toast.classList.add("toast-success");
        else if (type === "error") toast.classList.add("toast-error");
        else toast.classList.add("toast-info");
        toast.textContent = msg;
        toast.classList.add("show");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.remove("show");
        }, 2600);
      }

      function addLog(message, level = "system") {
        const logList = $("#logList");
        const li = document.createElement("li");
        li.className = "log-item";
        const now = new Date();
        const timeStr = now.toLocaleTimeString("zh-CN", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        const tagMap = {
          system: "ç³»ç»Ÿ",
          success: "æˆåŠŸ",
          error: "é”™è¯¯",
        };
        const tagClassMap = {
          system: "tag-system",
          success: "tag-success",
          error: "tag-error",
        };
        li.innerHTML = `
          <span class="time">${timeStr}</span>
          <span class="tag ${tagClassMap[level] || "tag-system"}">${
          tagMap[level] || "ç³»ç»Ÿ"
        }</span>
          <span>${message}</span>
        `;
        logList.prepend(li);
        const count = logList.children.length;
        $("#logCountBadge").textContent = `${count} æ¡`;
      }

      function updateStats() {
        const { today, total, success, fail } = state.stats;
        $("#statToday").textContent = today;
        $("#statTotal").textContent = total;
        const sum = success + fail;
        const rate = sum === 0 ? 0 : Math.round((success / sum) * 100);
        $("#statRate").textContent = `${rate}%`;
      }

      function updateApiStatus(ok) {
        const el = $("#apiStatus");
        el.className = "badge";
        if (!state.apiBase && !$("#inputApiBase").value.trim()) {
          el.classList.add("badge-gray");
          el.textContent = "æœªé…ç½®";
          return;
        }
        if (!state.token && !$("#inputToken").value.trim()) {
          el.classList.add("badge-gray");
          el.textContent = "æœªé…ç½® Token";
          return;
        }
        if (ok === true) {
          el.classList.add("badge-green");
          el.textContent = "å·²è¿æ¥";
        } else if (ok === false) {
          el.classList.add("badge-red");
          el.textContent = "å¼‚å¸¸";
        } else {
          el.classList.add("badge-gray");
          el.textContent = "å¾…æ£€æµ‹";
        }
      }

      function maskToken(token) {
        if (!token) return "";
        if (token.length <= 8) return "â€¢â€¢â€¢â€¢";
        return token.slice(0, 4) + " â€¢â€¢â€¢â€¢ " + token.slice(token.length - 4);
      }

      // é¡µé¢å±•ç¤ºç”¨çš„å¯†ç æ©ç ï¼ˆå¯¼å‡ºä»ç„¶æ˜¯æ˜æ–‡ï¼‰
      function maskPasswordDisplay(pw) {
        if (!pw) return "";
        const len = pw.length;
        const maskedLen = Math.max(4, Math.min(len, 12));
        return "â€¢".repeat(maskedLen);
      }

      function openDialog(id) {
        $("#overlay").classList.add("show");
        $(`#${id}`).classList.add("show");
      }

      function closeDialog(id) {
        const dialog = $(`#${id}`);
        if (dialog) dialog.classList.remove("show");
        const anyOpen = $$(".dialog.show").length > 0;
        if (!anyOpen) $("#overlay").classList.remove("show");
      }

      function refreshTokenHistoryUI() {
        const ul = $("#tokenHistoryList");
        ul.innerHTML = "";
        if (!state.tokenHistory.length) {
          const li = document.createElement("li");
          li.className = "muted-sm";
          li.textContent = "æš‚æ— å†å²è®°å½•ï¼Œå…ˆç”Ÿæˆä¸€ä¸ª Token è¯•è¯•å§ã€‚";
          ul.appendChild(li);
          return;
        }
        state.tokenHistory
          .slice()
          .sort((a, b) => b.time - a.time)
          .forEach((item) => {
            const li = document.createElement("li");
            li.className = "token-history-item";
            const dateStr = new Date(item.time).toLocaleString("zh-CN", {
              hour12: false,
            });
            li.innerHTML = `
              <div>
                <div class="token-history-token">${maskToken(item.token)}</div>
                <div class="token-history-meta">
                  ${item.adminEmail || "æœªçŸ¥é‚®ç®±"} Â· ${
              item.apiBase || "æœªçŸ¥åŸŸå"
            }<br/>${dateStr}
                </div>
              </div>
              <div>
                <button class="btn btn-ghost btn-sm" data-history-use="${
                  item.id
                }">ä½¿ç”¨</button>
              </div>
            `;
            ul.appendChild(li);
          });
      }

      function renderRecords() {
        const tbody = $("#recordTableBody");
        tbody.innerHTML = "";
        let list = state.records || [];
        if (currentFilter === "success") {
          list = list.filter((r) => r.status === "success");
        } else if (currentFilter === "fail") {
          list = list.filter((r) => r.status === "fail");
        }

        if (!list.length) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="6" style="text-align:center;padding:18px 8px"><span class="muted">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</span></td>';
          tbody.appendChild(tr);
          return;
        }

        list
          .slice()
          .sort((a, b) => b.time - a.time)
          .forEach((rec, idx) => {
            const tr = document.createElement("tr");
            const timeStr = new Date(rec.time).toLocaleString("zh-CN", {
              hour12: false,
            });
            const statusClass =
              rec.status === "success"
                ? "status-ok"
                : rec.status === "fail"
                ? "status-fail"
                : "status-pending";
            const statusText =
              rec.status === "success"
                ? "æˆåŠŸ"
                : rec.status === "fail"
                ? "å¤±è´¥"
                : "å¾…å¤„ç†";

            const displayPassword = maskPasswordDisplay(rec.password);

            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${htmlEsc(rec.email)}</td>
              <td>
                <span
                  class="pw-text"
                  data-real="${htmlEsc(rec.password || "")}"
                  data-masked="${displayPassword}"
                  data-showing="0"
                >${displayPassword}</span>
                <button
                  class="icon-btn icon-btn-mini pw-eye-btn"
                  type="button"
                  title="æŸ¥çœ‹/éšè—å¯†ç "
                >ğŸ‘</button>
                <button
                  class="icon-btn icon-btn-mini pw-copy-btn"
                  type="button"
                  title="å¤åˆ¶è´¦å·+å¯†ç "
                  data-email="${htmlEsc(rec.email || "")}"
                  data-password="${htmlEsc(rec.password || "")}"
                >ğŸ“‹</button>
              </td>
              <td><span class="status-tag ${statusClass}">${statusText}</span></td>
              <td>${timeStr}</td>
              <td>${htmlEsc(rec.message || "")}</td>
            `;
            tbody.appendChild(tr);
          });
      }

      // å½“å‰ç”¨æˆ·åæ¨¡å¼
      function getUsernameMode() {
        return (
          document.querySelector('input[name="usernameMode"]:checked')?.value ||
          "random"
        );
      }

      // æ ¹æ®è§„å¾‹æ¨¡å¼è‡ªåŠ¨åŒæ­¥æ•°å­—é•¿åº¦ï¼ˆå­¦å·/é€’å¢ï¼šèµ·å§‹å€¼é•¿åº¦ï¼›æ—¥æœŸï¼šå¯æ‰‹åŠ¨ï¼‰
      function syncPatternLengthUI() {
        const inputNumLen = $("#inputNumberLength");
        if (!inputNumLen) return;

        const mode = getUsernameMode();
        const numberMode =
          document.querySelector('input[name="numberMode"]:checked')?.value ||
          "random";
        const patternType = $("#selectPatternType")?.value || "student";

        // åªæœ‰åœ¨å­—æ¯+æ•°å­— / æ•°å­—+å­—æ¯ ä¸” è§„å¾‹æ¨¡å¼ æ—¶æ‰é”å®š
        if (mode === "random" || numberMode !== "pattern") {
          inputNumLen.disabled = false;
          inputNumLen.readOnly = false;
          return;
        }

        if (patternType === "date") {
          // æ—¥æœŸæ¨¡å¼ï¼šé•¿åº¦ç”±ç”¨æˆ·æ§åˆ¶
          inputNumLen.disabled = false;
          inputNumLen.readOnly = false;
        } else {
          // å­¦å· / é€’å¢ï¼šæ ¹æ®èµ·å§‹å€¼ä½æ•°è‡ªåŠ¨è¯†åˆ«å¹¶é”å®š
          const start = $("#inputPatternStart")?.value.trim() || "";
          let autoLen = start.length;
          if (!autoLen) {
            autoLen = Number(inputNumLen.value || 0) || 1;
          }
          inputNumLen.value = autoLen;
          inputNumLen.disabled = true;
          inputNumLen.readOnly = true;
        }
      }

      // æ ¹æ®æ¨¡å¼æ§åˆ¶æ•°å­—æ¨¡å¼åŒºåŸŸæ˜¾ç¤º/éšè— & é€‰é¡¹
      function syncNumberModeUI() {
        const mode = getUsernameMode();
        const group = $("#numberModeGroup");
        const rowNumberLength = $("#rowNumberLength");
        const rowPatternConfig = $("#rowPatternConfig");

        const noneInput = document.querySelector(
          '#numberModeGroup input[value="none"]'
        );
        const noneChip = noneInput && noneInput.parentElement;
        const randomInput = document.querySelector(
          '#numberModeGroup input[value="random"]'
        );

        if (mode === "random") {
          // å®Œå…¨éšæœºï¼šä¸éœ€è¦æ•°å­—æ¨¡å¼ï¼Œæ•´å—éšè—
          if (group) group.style.display = "none";
          if (rowNumberLength) rowNumberLength.style.display = "none";
          if (rowPatternConfig) rowPatternConfig.style.display = "none";

          // æ¢å¤ã€Œæ— æ•°å­—ã€é€‰é¡¹å¹¶è®¾ä¸ºé»˜è®¤
          if (noneChip && noneInput) {
            noneChip.style.display = "";
            $$("#numberModeGroup .chip").forEach((c) =>
              c.classList.remove("active")
            );
            noneInput.checked = true;
            noneChip.classList.add("active");
          }

          const inputNumLen = $("#inputNumberLength");
          if (inputNumLen) {
            inputNumLen.disabled = false;
            inputNumLen.readOnly = false;
          }
          return;
        }

        // å­—æ¯+æ•°å­— / æ•°å­—+å­—æ¯ï¼šéœ€è¦æ•°å­—æ¨¡å¼
        if (group) group.style.display = "";
        if (rowNumberLength) rowNumberLength.style.display = "";

        // éšè—ã€Œæ— æ•°å­—ã€é€‰é¡¹ï¼Œåªä¿ç•™ éšæœºæ•°å­— / è§„å¾‹æ¨¡å¼
        if (noneChip && noneInput) {
          noneChip.style.display = "none";
          if (noneInput.checked) {
            noneInput.checked = false;
          }
          noneChip.classList.remove("active");
        }

        // å½“å‰å·²é€‰ä¸­çš„æ•°å­—æ¨¡å¼
        let currentInput = document.querySelector(
          'input[name="numberMode"]:checked'
        );

        // å¦‚æœæ²¡é€‰ä¸­æˆ–ä»æ˜¯ noneï¼Œåˆ™é»˜è®¤é€‰ä¸­éšæœºæ•°å­—
        if (!currentInput || currentInput.value === "none") {
          if (randomInput) {
            currentInput = randomInput;
            randomInput.checked = true;
          }
        }

        // åˆ·æ–° chip é«˜äº®
        $$("#numberModeGroup .chip").forEach((chip) => {
          const input = chip.querySelector('input[name="numberMode"]');
          if (input && input.checked) chip.classList.add("active");
          else chip.classList.remove("active");
        });

        const numberMode = currentInput ? currentInput.value : "random";

        // åªæœ‰è§„å¾‹æ¨¡å¼å±•ç¤ºé…ç½®è¡Œ
        if (rowPatternConfig) {
          rowPatternConfig.style.display = numberMode === "pattern" ? "" : "none";
        }

        // åŒæ­¥æ•°å­—é•¿åº¦çš„è‡ªåŠ¨/å¯ç¼–è¾‘çŠ¶æ€
        syncPatternLengthUI();
      }

      function getCurrentNumberLength() {
        const mode = getUsernameMode();
        if (mode === "random") return 0;

        const numberMode =
          document.querySelector('input[name="numberMode"]:checked')?.value ||
          "random";
        const patternType = $("#selectPatternType")?.value || "student";

        if (numberMode === "random") {
          return Number($("#inputNumberLength").value || 0) || 0;
        }

        if (numberMode === "pattern") {
          if (patternType === "date") {
            return Number($("#inputNumberLength").value || 0) || 0;
          }
          const start = $("#inputPatternStart")?.value.trim() || "";
          if (start) return start.length;
          return Number($("#inputNumberLength").value || 0) || 0;
        }

        return 0;
      }

      function updateUsernamePreview() {
        const baseLen = Number($("#inputBaseLength").value || 0);
        const mode = getUsernameMode();

        // å®Œå…¨éšæœºï¼šåªæœ‰åŸºç¡€é•¿åº¦
        if (mode === "random") {
          $("#usernamePreview").textContent = `æ€»é•¿åº¦é¢„è§ˆï¼š${baseLen} ä½ï¼ˆä¸å«å‰ç¼€ä¸ @åŸŸåï¼‰`;
          return;
        }

        const numLen = getCurrentNumberLength();
        const total = baseLen + (Number.isFinite(numLen) ? numLen : 0);

        $("#usernamePreview").textContent = `é¢„è§ˆï¼šå­—æ¯ ${baseLen} ä½ + æ•°å­— ${numLen} ä½ â‰ˆ æ€» ${total} ä½ï¼ˆä¸å«å‰ç¼€ä¸ @åŸŸåï¼‰`;
      }

      function collectCheckedValues(groupSelector) {
        return $$(groupSelector + " input:checked").map((el) => el.value);
      }

      function randomFrom(chars) {
        if (!chars.length) return "";
        const idx = Math.floor(Math.random() * chars.length);
        return chars[idx];
      }

      function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function buildCharSet(selected) {
        const sets = {
          upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
          lower: "abcdefghijklmnopqrstuvwxyz",
          digit: "0123456789",
          symbol: "!@#$%^&*",
        };
        let result = "";
        selected.forEach((key) => {
          if (sets[key]) result += sets[key];
        });
        if (!result) {
          result = sets.upper + sets.lower + sets.digit;
        }
        return result;
      }

      function generatePassword() {
        const length =
          Number(
            document.querySelector('input[name="passwordLength"]:checked')
              ?.value || 10
          ) || 10;
        const selected = collectCheckedValues("#passwordCharsetGroup");
        const sets = {
          upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
          lower: "abcdefghijklmnopqrstuvwxyz",
          digit: "0123456789",
          symbol: "!@#$%^&*",
        };
        let allChars = "";
        const mandatoryChars = [];
        selected.forEach((key) => {
          if (sets[key]) {
            allChars += sets[key];
            mandatoryChars.push(randomFrom(sets[key]));
          }
        });
        if (!allChars) {
          allChars = sets.upper + sets.lower + sets.digit;
        }
        const chars = mandatoryChars.slice(
          0,
          Math.min(length, mandatoryChars.length)
        );
        while (chars.length < length) {
          chars.push(randomFrom(allChars));
        }
        shuffleArray(chars);
        return chars.join("");
      }

      function generateUsername(index) {
        const prefix = $("#inputUsernamePrefix").value.trim();
        const baseLen = Math.max(1, Number($("#inputBaseLength").value || 1));
        const mode = getUsernameMode();
        const numberModeRaw =
          document.querySelector('input[name="numberMode"]:checked')?.value ||
          "random";
        const usernameChars = buildCharSet(
          collectCheckedValues("#usernameCharsetGroup")
        );

        // å­—æ¯éƒ¨åˆ†é•¿åº¦ = åŸºç¡€é•¿åº¦
        let basePart = "";
        for (let i = 0; i < baseLen; i++) {
          basePart += randomFrom(usernameChars);
        }

        // å®Œå…¨éšæœºï¼šä¸å•ç‹¬ç”Ÿæˆæ•°å­—æ®µ
        if (mode === "random") {
          return prefix + basePart;
        }

        // å­—æ¯+æ•°å­— / æ•°å­—+å­—æ¯ï¼šæ•°å­—éƒ¨åˆ†å•ç‹¬å¤„ç†
        let numberMode = numberModeRaw;
        if (numberMode !== "random" && numberMode !== "pattern") {
          numberMode = "random";
        }

        let numLen = getCurrentNumberLength();
        if ((numberMode === "random" || numberMode === "pattern") && numLen <= 0) {
          numLen = 1;
        }

        let numPart = "";
        if (numberMode === "random") {
          const digits = "0123456789";
          for (let i = 0; i < numLen; i++) {
            numPart += randomFrom(digits);
          }
        } else if (numberMode === "pattern") {
          const patternType = $("#selectPatternType").value;
          const start = $("#inputPatternStart").value.trim();
          if (patternType === "date") {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const base = `${y}${m}${dd}`;
            numPart =
              numLen >= base.length
                ? base.padStart(numLen, "0")
                : base.slice(-numLen);
          } else {
            const baseVal = parseInt(start || "0", 10) || 0;
            const value = baseVal + index;
            let s = String(value);
            const targetLen = Math.max(start.length || 0, numLen);
            if (targetLen > 0) s = s.padStart(targetLen, "0");
            numPart =
              numLen && numLen < s.length ? s.slice(-numLen) : s;
          }
        }

        let core = "";
        if (mode === "letter-digit") {
          core = basePart + numPart;
        } else if (mode === "digit-letter") {
          core = numPart + basePart;
        } else {
          core = basePart;
        }

        return prefix + core;
      }

      function buildEmail(username) {
        let domain = $("#inputDomain").value.trim();
        if (!domain) return "";
        if (!domain.startsWith("@")) {
          domain = "@" + domain;
        }
        return username + domain;
      }

      function normalizeBase(url) {
        let u = url.trim();
        if (!u) return "";
        if (u.endsWith("/")) u = u.slice(0, -1);
        return u;
      }

      async function apiGenToken() {
        const apiBase = normalizeBase($("#inputApiBase").value);
        const email = $("#inputAdminEmail").value.trim();
        const password = $("#inputAdminPassword").value;
        if (!apiBase || !email || !password) {
          showToast("error", "è¯·å®Œæ•´å¡«å†™ API åŸŸåã€ç®¡ç†å‘˜é‚®ç®±ä¸å¯†ç ");
          return;
        }
        try {
          running = true;
          $("#btnGenToken").disabled = true;
          addLog("æ­£åœ¨è¯·æ±‚ç”Ÿæˆ Token ...", "system");
          const res = await fetch(apiBase + "/api/public/genToken", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (res.ok && data && data.code === 200 && data.data?.token) {
            const token = data.data.token;
            state.apiBase = apiBase;
            state.token = token;
            state.adminEmail = email;
            $("#inputApiBase").value = apiBase;
            $("#inputToken").value = token;
            $("#inputAdminEmail").value = email;
            addLog("Token ç”ŸæˆæˆåŠŸ", "success");
            showToast("success", "Token å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°");
            updateApiStatus(true);

            state.tokenHistory.push({
              id: Date.now(),
              token,
              apiBase,
              adminEmail: email,
              time: Date.now(),
            });
            if (state.tokenHistory.length > 20) {
              state.tokenHistory = state.tokenHistory.slice(-20);
            }
            refreshTokenHistoryUI();
            saveState();
          } else {
            const msg = data?.message || "æœªçŸ¥é”™è¯¯";
            addLog(`Token ç”Ÿæˆå¤±è´¥ï¼š${msg}`, "error");
            showToast("error", "Token ç”Ÿæˆå¤±è´¥ï¼š" + msg);
            updateApiStatus(false);
          }
        } catch (e) {
          console.error(e);
          addLog("Token ç”Ÿæˆå¼‚å¸¸ï¼š" + e.message, "error");
          showToast("error", "ç½‘ç»œæˆ–è·¨åŸŸå¼‚å¸¸ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…");
          updateApiStatus(false);
        } finally {
          $("#btnGenToken").disabled = false;
          running = false;
        }
      }

      async function apiAddUser(user) {
        const apiBase = normalizeBase($("#inputApiBase").value || state.apiBase);
        const token = $("#inputToken").value.trim() || state.token;
        if (!apiBase || !token) {
          throw new Error("å°šæœªé…ç½® API åŸŸåæˆ– Token");
        }
        const url = apiBase + "/api/public/addUser";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: token,
          },
          body: JSON.stringify({ list: [user] }),
        });
        const data = await res.json();
        if (!res.ok || !data || data.code !== 200) {
          const msg = data?.message || `HTTP ${res.status}`;
          const err = new Error(msg);
          err.code = data?.code || res.status;
          throw err;
        }
        return data;
      }

      async function checkApiConnectivity() {
        const apiBase = normalizeBase($("#inputApiBase").value || state.apiBase);
        const token = $("#inputToken").value.trim() || state.token;

        if (!apiBase) {
          showToast("error", "è¯·å…ˆé…ç½® API åŸŸå");
          addLog("API è”é€šæ£€æµ‹å¤±è´¥ï¼šæœªé…ç½® API åŸŸå", "error");
          return;
        }

        const btn = $("#btnCheckApi");
        try {
          if (btn) btn.disabled = true;
          addLog("æ­£åœ¨æ£€æµ‹ API è”é€šæ€§ ...", "system");

          const url = apiBase + "/api/public/emailList";
          const headers = { "Content-Type": "application/json" };
          if (token) {
            headers.Authorization = token;
          }
          const payload = { num: 1, size: 1 };

          const res = await fetch(url, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          let data = {};
          try {
            data = await res.json();
          } catch (_) {
            data = {};
          }

          if (res.ok && data && data.code === 200) {
            updateApiStatus(true);
            showToast("success", "API è”é€šæ­£å¸¸");
            addLog("API è”é€šæ£€æµ‹æˆåŠŸ", "success");
          } else {
            let msg =
              (data && (data.message || data.msg)) || `HTTP ${res.status}`;
            if (res.status === 401 || res.status === 403) {
              msg = `API å¯è®¿é—®ï¼Œä½† Token æ— æ•ˆï¼ˆ${msg}ï¼‰`;
            } else {
              msg = `API å¯è®¿é—®ï¼Œä½†è¿”å›å¼‚å¸¸ï¼ˆ${msg}ï¼‰`;
            }
            updateApiStatus(false);
            showToast("error", msg);
            addLog("API è”é€šæ£€æµ‹è¿”å›å¼‚å¸¸ï¼š" + msg, "error");
          }
        } catch (e) {
          console.error(e);
          updateApiStatus(false);
          showToast("error", "æ— æ³•è¿æ¥ APIï¼š" + e.message);
          addLog("API è”é€šæ£€æµ‹å¤±è´¥ï¼š" + e.message, "error");
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      async function apiEmailList() {
        const apiBase = normalizeBase($("#inputApiBase").value || state.apiBase);
        const token = $("#inputToken").value.trim() || state.token;
        if (!apiBase || !token) {
          showToast("error", "è¯·å…ˆé…ç½® API åŸŸåä¸ Token");
          return;
        }
        const payload = {
          toEmail: $("#inputToEmail").value.trim() || undefined,
          sendEmail: $("#inputSendEmail").value.trim() || undefined,
          subject: $("#inputSubject").value.trim() || undefined,
          timeSort: $("#selectTimeSort").value || undefined,
          type: $("#selectEmailType").value || undefined,
          isDel: $("#selectIsDel").value || undefined,
          num: Number($("#inputPageNum").value || 1) || 1,
          size: Number($("#inputPageSize").value || 20) || 20,
        };
        try {
          $("#btnQueryEmail").disabled = true;
          addLog("æ­£åœ¨æŸ¥è¯¢é‚®ä»¶åˆ—è¡¨ ...", "system");
          const res = await fetch(apiBase + "/api/public/emailList", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (res.ok && data && data.code === 200 && Array.isArray(data.data)) {
            emailCache = data.data;
            renderEmailList();
            showToast("success", `æŸ¥è¯¢æˆåŠŸï¼Œå…± ${data.data.length} æ¡`);
            addLog(`é‚®ä»¶æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${data.data.length} æ¡`, "success");
            updateApiStatus(true);
          } else {
            const msg = data?.message || "æœªçŸ¥é”™è¯¯";
            showToast("error", "é‚®ä»¶æŸ¥è¯¢å¤±è´¥ï¼š" + msg);
            addLog("é‚®ä»¶æŸ¥è¯¢å¤±è´¥ï¼š" + msg, "error");
            updateApiStatus(false);
          }
        } catch (e) {
          console.error(e);
          showToast("error", "é‚®ä»¶æŸ¥è¯¢å¼‚å¸¸ï¼š" + e.message);
          addLog("é‚®ä»¶æŸ¥è¯¢å¼‚å¸¸ï¼š" + e.message, "error");
          updateApiStatus(false);
        } finally {
          $("#btnQueryEmail").disabled = false;
        }
      }

      function renderEmailList() {
        const tbody = $("#emailTableBody");
        tbody.innerHTML = "";
        if (!emailCache.length) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="7" style="text-align:center;padding:16px 8px"><span class="muted">æš‚æ— æ•°æ®</span></td>';
          tbody.appendChild(tr);
          return;
        }
        emailCache.forEach((item, idx) => {
          const tr = document.createElement("tr");
          const typeText = item.type === 1 ? "å‘ä»¶" : "æ”¶ä»¶";
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td><span class="badge-type">${typeText}</span></td>
            <td>${
              item.sendName
                ? htmlEsc(item.sendName) +
                  " &lt;" +
                  htmlEsc(item.sendEmail) +
                  "&gt;"
                : htmlEsc(item.sendEmail || "")
            }</td>
            <td>${
              item.toName
                ? htmlEsc(item.toName) +
                  " &lt;" +
                  htmlEsc(item.toEmail) +
                  "&gt;"
                : htmlEsc(item.toEmail || "")
            }</td>
            <td>${htmlEsc(item.subject || "")}</td>
            <td>${htmlEsc(item.createTime || "")}</td>
            <td><button class="btn btn-ghost btn-sm" data-email-index="${idx}">æŸ¥çœ‹</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      function openEmailDetail(index) {
        const item = emailCache[index];
        if (!item) return;
        const container = $("#emailDetailContent");
        const typeText = item.type === 1 ? "å‘ä»¶" : "æ”¶ä»¶";
        const htmlEscLocal = (str) =>
          (str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        container.innerHTML = `
          <div class="email-detail-row">
            <span class="label">ç±»å‹</span>
            <span class="badge-type">${typeText}</span>
          </div>
          <div class="email-detail-row">
            <span class="label">å‘ä»¶äºº</span>
            <span>${htmlEscLocal(item.sendName || "")} ${
          item.sendEmail
            ? "&lt;" + htmlEscLocal(item.sendEmail) + "&gt;"
            : ""
        }</span>
          </div>
          <div class="email-detail-row">
            <span class="label">æ”¶ä»¶äºº</span>
            <span>${htmlEscLocal(item.toName || "")} ${
          item.toEmail ? "&lt;" + htmlEscLocal(item.toEmail) + "&gt;" : ""
        }</span>
          </div>
          <div class="email-detail-row">
            <span class="label">æ—¶é—´</span>
            <span>${htmlEscLocal(item.createTime || "")}</span>
          </div>
          <div class="email-detail-row">
            <span class="label">ä¸»é¢˜</span>
            <span>${htmlEscLocal(item.subject || "")}</span>
          </div>
          <div class="email-detail-row">
            <span class="label">æ–‡æœ¬</span>
            <span>${htmlEscLocal(item.text || "")}</span>
          </div>
          <div class="email-body-viewer" style="margin-top:8px">
            <iframe srcdoc="${(item.content || "").replace(
              /"/g,
              "&quot;"
            )}"></iframe>
          </div>
        `;
        openDialog("dialogEmailDetail");
      }

      async function startRegister() {
        if (running) return;
        const apiBase = normalizeBase($("#inputApiBase").value || state.apiBase);
        const token = $("#inputToken").value.trim() || state.token;
        if (!apiBase || !token) {
          showToast("error", "è¯·å…ˆé…ç½® API åŸŸåä¸ Token");
          addLog("å¼€å§‹æ³¨å†Œå‰æ£€æŸ¥å¤±è´¥ï¼šæœªé…ç½® API æˆ– Token", "error");
          return;
        }

        const count = Math.max(
          1,
          Math.min(100, Number($("#inputCount").value || 0))
        );
        $("#inputCount").value = count;
        const domain = $("#inputDomain").value.trim();
        if (!domain) {
          showToast("error", "è¯·å¡«å†™é‚®ç®±åŸŸå");
          return;
        }

        updateUsernamePreview();

        running = true;
        $("#btnStartRegister").disabled = true;
        $("#btnResetSettings").disabled = true;
        updateApiStatus();

        const roleName = $("#inputRoleName").value.trim() || undefined;

        addLog(`å¼€å§‹æ‰¹é‡æ³¨å†Œï¼Œå…± ${count} ä¸ªè´¦å·`, "system");
        $("#progressStatus").textContent = "æ­£åœ¨ç”Ÿæˆç”¨æˆ·åå’Œå¯†ç  ...";

        const tasks = [];
        for (let i = 0; i < count; i++) {
          const username = generateUsername(i);
          const email = buildEmail(username);
          const password = generatePassword();
          tasks.push({ email, password, roleName });
        }

        let successCount = 0;
        let failCount = 0;
        let processed = 0;
        const total = tasks.length;
        const startTime = Date.now();

        for (const task of tasks) {
          processed++;
          const percent = Math.round((processed / total) * 100);
          $("#progressText").textContent = `${processed} / ${total} Â· ${percent}%`;
          $("#progressBar").style.width = `${percent}%`;
          $("#progressStatus").textContent = `ç¬¬ ${processed}/${total} ä¸ªï¼š${
            task.email
          }`;

          const record = {
            email: task.email,
            password: task.password,
            roleName: task.roleName,
            status: "pending",
            message: "",
            time: Date.now(),
          };

          try {
            await apiAddUser({
              email: task.email,
              password: task.password,
              roleName: task.roleName,
            });
            record.status = "success";
            record.message = "";
            successCount++;
            addLog(`æ³¨å†ŒæˆåŠŸï¼š${task.email}`, "success");
          } catch (e) {
            record.status = "fail";
            record.message = e.message || "æœªçŸ¥é”™è¯¯";
            failCount++;
            addLog(`æ³¨å†Œå¤±è´¥ï¼š${task.email} Â· ${e.message}`, "error");
            updateApiStatus(false);
          }
          state.records.push(record);
          if (state.records.length > 500) {
            state.records = state.records.slice(-500);
          }
          renderRecords();
          saveState();
        }

        const duration = Math.round((Date.now() - startTime) / 1000);
        const summary = `æ‰¹é‡æ³¨å†Œå®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ªï¼Œç”¨æ—¶ ${duration} ç§’`;
        $("#progressStatus").textContent = summary;
        showToast(failCount ? "info" : "success", summary);
        addLog(summary, failCount ? "system" : "success");

        state.stats.today += successCount;
        state.stats.total += successCount;
        state.stats.success += successCount;
        state.stats.fail += failCount;
        updateStats();
        updateApiStatus(failCount === 0);
        saveState();

        running = false;
        $("#btnStartRegister").disabled = false;
        $("#btnResetSettings").disabled = false;
      }

      function exportRecords() {
        if (!state.records.length) {
          showToast("info", "æš‚æ— å¯å¯¼å‡ºçš„è®°å½•");
          return;
        }
        const header = ["åºå·", "é‚®ç®±åœ°å€", "å¯†ç ", "çŠ¶æ€", "æ—¶é—´", "å¤‡æ³¨"];
        const lines = state.records
          .slice()
          .sort((a, b) => a.time - b.time)
          .map((rec, idx) => {
            const status =
              rec.status === "success"
                ? "æˆåŠŸ"
                : rec.status === "fail"
                ? "å¤±è´¥"
                : "å¾…å¤„ç†";
            const timeStr = new Date(rec.time).toLocaleString("zh-CN", {
              hour12: false,
            });
            // å¯¼å‡ºæ—¶ä½¿ç”¨æ˜æ–‡å¯†ç  rec.password
            return [
              String(idx + 1),
              rec.email || "",
              rec.password || "",
              status,
              timeStr,
              rec.message || "",
            ];
          });

        const escapeCsv = (value) =>
          `"${String(value || "").replace(/"/g, '""')}"`;
        let csv = header.map(escapeCsv).join(",") + "\n";
        csv += lines.map((row) => row.map(escapeCsv).join(",")).join("\n");

        const blob = new Blob(["\uFEFF" + csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `æ³¨å†Œç»“æœ_${todayStr()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("success", "CSV å¯¼å‡ºå®Œæˆ");
      }

      function clearRecordsConfirm() {
        openDialog("dialogConfirmClear");
      }

      function clearRecords() {
        state.records = [];
        renderRecords();
        saveState();
        addLog("å·²æ¸…ç©ºæœ¬åœ°æ³¨å†Œè®°å½•", "system");
        showToast("info", "å·²æ¸…ç©ºæœ¬åœ°è®°å½•");
      }

      function clearLog() {
        $("#logList").innerHTML = "";
        $("#logCountBadge").textContent = "0 æ¡";
      }

      function clearTokenHistory() {
        state.tokenHistory = [];
        refreshTokenHistoryUI();
        saveState();
        addLog("å·²æ¸…ç©º Token å†å²è®°å½•", "system");
        showToast("info", "Token å†å²å·²æ¸…ç©º");
      }

      // âœ… å¤åˆ¶å‡½æ•°ï¼šä¼˜å…ˆ navigator.clipboardï¼Œå¤±è´¥è‡ªåŠ¨é™çº§ execCommand
      async function copyTextToClipboard(text) {
        const legacyCopy = () => {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.opacity = "0";
          document.body.appendChild(ta);

          ta.focus();
          ta.select();

          try {
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            if (!ok) {
              throw new Error("execCommand copy è¿”å› false");
            }
            return true;
          } catch (err) {
            document.body.removeChild(ta);
            return false;
          }
        };

        // â‘  ä¼˜å…ˆä½¿ç”¨ç°ä»£å‰ªè´´æ¿ API
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            showToast("success", "å·²å¤åˆ¶è´¦å·+å¯†ç ");
            return;
          } catch (e) {
            console.warn("navigator.clipboard å¤±è´¥ï¼Œé™çº§åˆ° execCommandï¼š", e);
          }
        }

        // â‘¡ é™çº§æ—§æ–¹æ¡ˆ
        const ok = legacyCopy();
        if (ok) {
          showToast("success", "å·²å¤åˆ¶è´¦å·+å¯†ç ");
          return;
        }

        // â‘¢ ä¸¤ç§æ–¹å¼éƒ½å¤±è´¥
        showToast("error", "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰é€‰æ‹©å¤åˆ¶");
      }

      function setupEvents() {
        // Token æ˜¾ç¤º / æ¸…ç©º
        $("#btnToggleToken").addEventListener("click", () => {
          const input = $("#inputToken");
          input.type = input.type === "password" ? "text" : "password";
        });
        $("#btnClearToken").addEventListener("click", () => {
          $("#inputToken").value = "";
          state.token = "";
          saveState();
          updateApiStatus();
        });

        // ç”Ÿæˆ Token
        $("#btnGenToken").addEventListener("click", apiGenToken);

        // Token å†å²å¼¹çª—
        $("#btnTokenHistory").addEventListener("click", () => {
          refreshTokenHistoryUI();
          openDialog("dialogTokenHistory");
        });

        // overlay & é€šç”¨å…³é—­
        $$("#overlay, [data-dialog-close]").forEach((el) => {
          el.addEventListener("click", () => {
            const id = el.dataset.dialogClose;
            if (id) {
              closeDialog(id);
            } else {
              [
                "dialogTokenHistory",
                "dialogConfirmClear",
                "dialogEmailDetail",
              ].forEach((d) => closeDialog(d));
            }
          });
        });

        // Token å†å²ä½¿ç”¨ / æ¸…ç©º
        $("#tokenHistoryList").addEventListener("click", (e) => {
          const id = e.target.dataset.historyUse;
          if (!id) return;
          const item = state.tokenHistory.find((x) => String(x.id) === String(id));
          if (!item) return;
          state.apiBase = item.apiBase || state.apiBase;
          state.token = item.token;
          state.adminEmail = item.adminEmail || state.adminEmail;
          $("#inputApiBase").value = state.apiBase;
          $("#inputToken").value = state.token;
          $("#inputAdminEmail").value = state.adminEmail || "";
          saveState();
          updateApiStatus();
          addLog("å·²ä»å†å²è®°å½•åŠ è½½ Token", "system");
          showToast("success", "å·²åº”ç”¨è¯¥ Token");
          closeDialog("dialogTokenHistory");
        });
        $("#btnClearTokenHistory").addEventListener("click", clearTokenHistory);

        // ç”¨æˆ·åæ¨¡å¼
        $$("#usernameModeGroup .chip input").forEach((input) => {
          input.addEventListener("change", () => {
            $$("#usernameModeGroup .chip").forEach((c) =>
              c.classList.remove("active")
            );
            input.parentElement.classList.add("active");

            syncNumberModeUI();
            updateUsernamePreview();
          });
        });

        // æ•°å­—æ¨¡å¼
        $$("#numberModeGroup .chip input").forEach((input) => {
          input.addEventListener("change", () => {
            $$("#numberModeGroup .chip").forEach((c) =>
              c.classList.remove("active")
            );
            input.parentElement.classList.add("active");

            syncNumberModeUI();
            updateUsernamePreview();
          });
        });

        // è§„å¾‹æ¨¡å¼ç±»å‹ã€èµ·å§‹å€¼å˜åŒ–æ—¶ï¼ŒåŒæ­¥é•¿åº¦ & é¢„è§ˆ
        const selPatternType = $("#selectPatternType");
        if (selPatternType) {
          selPatternType.addEventListener("change", () => {
            syncPatternLengthUI();
            updateUsernamePreview();
          });
        }
        const inputPatternStart = $("#inputPatternStart");
        if (inputPatternStart) {
          inputPatternStart.addEventListener("input", () => {
            syncPatternLengthUI();
            updateUsernamePreview();
          });
        }

        $("#inputBaseLength").addEventListener("input", () => {
          updateUsernamePreview();
        });
        $("#inputNumberLength").addEventListener("input", () => {
          updateUsernamePreview();
        });

        // å¯†ç é•¿åº¦é€‰é¡¹
        $$("#passwordLengthGroup .chip input").forEach((input) => {
          input.addEventListener("change", () => {
            $$("#passwordLengthGroup .chip").forEach((c) =>
              c.classList.remove("active")
            );
            input.parentElement.classList.add("active");
          });
        });

        // Charset é€‰é¡¹é«˜äº®
        [
          "#usernameCharsetGroup .chip input",
          "#passwordCharsetGroup .chip input",
        ].forEach((selector) => {
          $$(selector).forEach((input) => {
            input.addEventListener("change", () => {
              if (input.checked) input.parentElement.classList.add("active");
              else input.parentElement.classList.remove("active");
            });
          });
        });

        // å¼€å§‹æ³¨å†Œ / é‡ç½®
        $("#btnStartRegister").addEventListener("click", startRegister);
        $("#btnResetSettings").addEventListener("click", () => {
          $("#inputCount").value = 10;
          $("#inputDomain").value = "";
          $("#inputUsernamePrefix").value = "";
          $("#inputBaseLength").value = 6;
          document.querySelector(
            'input[name="usernameMode"][value="random"]'
          ).checked = true;
          $$("#usernameModeGroup .chip").forEach((c) =>
            c.classList.remove("active")
          );
          document
            .querySelector(
              '#usernameModeGroup input[name="usernameMode"][value="random"]'
            )
            .parentElement.classList.add("active");
          document.querySelector(
            'input[name="numberMode"][value="none"]'
          ).checked = true;
          $$("#numberModeGroup .chip").forEach((c) =>
            c.classList.remove("active")
          );
          document
            .querySelector(
              '#numberModeGroup input[name="numberMode"][value="none"]'
            )
            .parentElement.classList.add("active");
          $("#rowNumberLength").style.display = "none";
          $("#rowPatternConfig").style.display = "none";
          $("#inputNumberLength").value = 3;
          $("#selectPatternType").value = "student";
          $("#inputPatternStart").value = "";

          // ç”¨æˆ·åå­—ç¬¦ç±»å‹
          $$("#usernameCharsetGroup input").forEach((input) => {
            input.checked = ["upper", "lower", "digit"].includes(input.value);
            if (input.checked) input.parentElement.classList.add("active");
            else input.parentElement.classList.remove("active");
          });

          // å¯†ç é•¿åº¦
          document.querySelector(
            '#passwordLengthGroup input[name="passwordLength"][value="10"]'
          ).checked = true;
          $$("#passwordLengthGroup .chip").forEach((c) =>
            c.classList.remove("active")
          );
          document
            .querySelector(
              '#passwordLengthGroup input[name="passwordLength"][value="10"]'
            )
            .parentElement.classList.add("active");

          // å¯†ç å­—ç¬¦ç±»å‹
          $$("#passwordCharsetGroup input").forEach((input) => {
            input.checked = ["upper", "lower", "digit"].includes(input.value);
            if (input.checked) input.parentElement.classList.add("active");
            else input.parentElement.classList.remove("active");
          });

          $("#inputRoleName").value = "";
          syncNumberModeUI();
          updateUsernamePreview();
          showToast("info", "æ³¨å†Œé…ç½®å·²æ¢å¤é»˜è®¤");
        });

        // ç»“æœè¿‡æ»¤
        $("#resultFilterGroup").addEventListener("click", (e) => {
          const btn = e.target.closest(".pill-filter");
          if (!btn) return;
          $$("#resultFilterGroup .pill-filter").forEach((b) =>
            b.classList.remove("active")
          );
          btn.classList.add("active");
          currentFilter = btn.dataset.filter || "all";
          renderRecords();
        });

        // å¯†ç æŸ¥çœ‹ / å•æ¡å¤åˆ¶è´¦å·å¯†ç ï¼ˆäº‹ä»¶ä»£ç†ï¼‰
        $("#recordTableBody").addEventListener("click", (e) => {
          const eyeBtn = e.target.closest(".pw-eye-btn");
          if (eyeBtn) {
            const cell = eyeBtn.closest("td");
            const span = cell && cell.querySelector(".pw-text");
            if (!span) return;
            const showing = span.dataset.showing === "1";
            if (showing) {
              span.textContent =
                span.dataset.masked ||
                maskPasswordDisplay(span.dataset.real || "");
              span.dataset.showing = "0";
            } else {
              span.textContent = span.dataset.real || "";
              span.dataset.showing = "1";
            }
            return;
          }
          const copyBtn = e.target.closest(".pw-copy-btn");
          if (copyBtn) {
            const email = copyBtn.dataset.email || "";
            const password = copyBtn.dataset.password || "";
            const text =
              email && password ? `${email}\t${password}` : email || password;
            if (text) {
              copyTextToClipboard(text);
            }
          }
        });

        // å¯¼å‡º / æ¸…ç©ºè®°å½•
        $("#btnExportRecords").addEventListener("click", exportRecords);
        $("#btnClearRecords").addEventListener("click", clearRecordsConfirm);
        $("#btnConfirmClearRecords").addEventListener("click", () => {
          clearRecords();
          closeDialog("dialogConfirmClear");
        });

        // æ¸…ç©ºæ—¥å¿—
        $("#btnClearLog").addEventListener("click", clearLog);

        // é‚®ä»¶æŸ¥è¯¢
        $("#btnQueryEmail").addEventListener("click", apiEmailList);
        $("#emailTableBody").addEventListener("click", (e) => {
          const idx = e.target.dataset.emailIndex;
          if (idx === undefined) return;
          openEmailDetail(Number(idx));
        });

        // API è”é€šæ£€æµ‹
        const btnCheck = $("#btnCheckApi");
        if (btnCheck) {
          btnCheck.addEventListener("click", checkApiConnectivity);
        }

        // API é…ç½® blur ä¿å­˜
        $("#inputApiBase").addEventListener("blur", () => {
          state.apiBase = normalizeBase($("#inputApiBase").value);
          $("#inputApiBase").value = state.apiBase;
          saveState();
          updateApiStatus();
        });
        $("#inputToken").addEventListener("blur", () => {
          state.token = $("#inputToken").value.trim();
          saveState();
          updateApiStatus();
        });
        $("#inputAdminEmail").addEventListener("blur", () => {
          state.adminEmail = $("#inputAdminEmail").value.trim();
          saveState();
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupEvents();
        loadState();
      });
    })();
  </script>
</body>
</html>
