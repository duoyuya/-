<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮箱批量注册系统 - 北沐</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                    }
                }
            }
        }
    </script>
    <style>
        /* 全局样式优化 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden; /* 防止水平滚动条 */
        }
        
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563EB 0%, #059669 100%);
        }
        
        /* 页面容器 - 增加内边距防止内容紧贴边缘 */
        .page-container {
            max-width: 7xl;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden; /* 防止内容溢出 */
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #3B82F6;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid #3B82F6;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }
        
        .btn-danger {
            background: #EF4444;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        
        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .input-number {
            width: 80px;
            text-align: center;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 500px;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #10B981;
            color: white;
        }
        
        .badge-error {
            background: #EF4444;
            color: white;
        }
        
        .badge-warning {
            background: #F59E0B;
            color: white;
        }
        
        .badge-info {
            background: #3B82F6;
            color: white;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .copy-btn {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            border-radius: 6px;
        }
        
        .copy-btn:hover {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .masked-input {
            font-family: monospace;
            letter-spacing: 1px;
        }
        
        .security-tip {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 14px 18px;
            border-radius: 0 10px 10px 0;
            margin: 10px 0;
            font-size: 14px;
            color: #0c4a6e;
            line-height: 1.6;
        }
        
        .config-group {
            background: #f9fafb;
            border-radius: 16px;
            padding: 20px;
            margin: 12px 0;
            border: 1px solid #e5e7eb;
        }
        
        .config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .config-title {
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        
        .config-title i {
            margin-right: 10px;
            color: #3B82F6;
            font-size: 18px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 10px 14px;
            position: absolute;
            z-index: 1;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            white-space: normal;
            line-height: 1.5;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .password-masked {
            font-family: monospace;
            letter-spacing: 2px;
        }
        
        .mode-badge {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
        }
        
        .mode-badge i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            border-color: #3B82F6;
            background: #f8fafc;
        }
        
        .checkbox-item input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .checkbox-item span {
            font-size: 14px;
            color: #374151;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            align-items: flex-end;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-hint {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        
        .action-buttons button {
            flex: 1;
        }
        
        /* 表格样式优化 */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 12px 16px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s ease;
        }
        
        .data-table tr:hover td {
            background: #f8fafc;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* 响应式优化 - 更加精细的断点设置 */
        @media (max-width: 1200px) {
            .page-container {
                max-width: 90%;
            }
        }
        
        @media (max-width: 992px) {
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-4 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .card {
                border-radius: 12px;
                padding: 16px;
            }
            
            .config-group {
                padding: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .page-container {
                padding: 0.5rem;
            }
            
            .card {
                margin-bottom: 1rem;
                padding: 12px;
            }
            
            .btn-primary, .btn-secondary, .btn-danger {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .input-field {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .input-number {
                width: 70px;
            }
            
            .data-table th, .data-table td {
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 375px) {
            .card {
                border-radius: 8px;
                padding: 10px;
            }
            
            .btn-primary, .btn-secondary, .btn-danger {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .input-field {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .badge {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
        }
        
        /* 确保模态框在小屏幕上正常显示 */
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 0 10px;
            }
        }
        
        /* 修复移动端的输入框问题 */
        @media (max-width: 360px) {
            .form-label {
                font-size: 13px;
            }
            
            .form-hint {
                font-size: 11px;
            }
            
            .checkbox-item span {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- 页面容器 - 增加内边距防止内容紧贴边缘 -->
    <div class="page-container">
        <!-- 顶部导航 -->
        <nav class="bg-white/90 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50 mb-6">
            <div class="flex justify-between items-center h-16 px-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
                        <i class="fa fa-envelope text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">邮箱批量注册系统</h1>
                        <p class="text-xs text-gray-500">北沐版 v1.8</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="helpBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fa fa-question-circle text-gray-600"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 主要内容 -->
        <div class="space-y-6">
            <!-- 状态卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">今日注册</p>
                            <p id="todayCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fa fa-plus text-primary text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">总注册数</p>
                            <p id="totalCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i class="fa fa-trophy text-secondary text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">成功率</p>
                            <p id="successRate" class="text-2xl font-bold text-gray-900">0%</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                            <i class="fa fa-check-circle text-accent text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">API状态</p>
                            <div class="flex items-center mt-2">
                                <span id="apiStatusBadge" class="badge badge-warning">未连接</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fa fa-server text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 配置区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- API配置和注册设置 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- API配置 -->
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">
                            <i class="fa fa-cogs mr-2 text-primary"></i>
                            API配置
                        </h2>
                        
                        <div class="space-y-6">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        API域名 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="apiDomain" 
                                           class="input-field"
                                           placeholder="输入您的邮箱登录地址域名">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        Access Token <span class="badge badge-info text-xs px-2 py-1 ml-2">已加密</span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="accessToken" 
                                               class="input-field pr-16 masked-input"
                                               placeholder="请生成或输入Token" readonly>
                                        <button id="toggleTokenBtn" 
                                                class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary copy-btn"
                                                onclick="toggleTokenVisibility()">
                                            <i id="toggleTokenIcon" class="fa fa-eye-slash"></i>
                                        </button>
                                        <button id="copyTokenBtn" 
                                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary copy-btn"
                                                onclick="copyToken()">
                                            <i class="fa fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="security-tip">
                                <i class="fa fa-shield mr-2"></i>
                                Token已加密显示，点击眼睛图标可临时查看完整内容
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        管理员邮箱 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="email" id="adminEmail" 
                                           class="input-field"
                                           placeholder="输入您的管理员邮箱">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        管理员密码 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="password" id="adminPassword" 
                                           class="input-field"
                                           placeholder="请输入密码">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <button id="generateTokenBtn" 
                                        class="btn-primary"
                                        onclick="generateToken()">
                                    <i class="fa fa-bullseye mr-2"></i>生成Token
                                </button>
                                <button id="loadTokenBtn" 
                                        class="btn-secondary"
                                        onclick="showTokenHistory()">
                                    <i class="fa fa-history mr-2"></i>Token历史
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 注册设置 -->
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">
                            <i class="fa fa-users mr-2 text-primary"></i>
                            注册设置
                        </h2>
                        
                        <div class="space-y-6">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        注册数量 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" id="registerCount" min="1" max="100" value="5"
                                           class="input-field input-number">
                                    <span class="form-hint">单次最多注册100个账号</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        邮箱域名 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="emailDomain" 
                                           class="input-field"
                                           placeholder="example.com">
                                </div>
                            </div>
                            
                            <!-- 用户名配置 -->
                            <div class="config-group">
                                <div class="config-header">
                                    <div class="config-title">
                                        <i class="fa fa-user"></i>
                                        用户名配置
                                    </div>
                                    <div class="tooltip">
                                        <i class="fa fa-question-circle text-gray-400"></i>
                                        <span class="tooltiptext">
                                            配置用户名的生成规则，包括前缀、长度和字符类型
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="space-y-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            用户名前缀
                                        </label>
                                        <input type="text" id="usernamePrefix" 
                                               class="input-field"
                                               placeholder="可选，如：user_">
                                        <span class="form-hint">留空将使用完全随机的用户名</span>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                基础长度 <span class="text-red-500">*</span>
                                            </label>
                                            <input type="number" id="usernameLength" min="1" max="20" value="6"
                                                   class="input-field input-number">
                                            <span class="form-hint">字母部分的长度(1-20位)</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 生成模式选择 -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            生成模式 <span class="text-red-500">*</span>
                                        </label>
                                        <select id="generationMode" class="input-field" onchange="updatePatternOptions()">
                                            <option value="random">完全随机</option>
                                            <option value="letters_numbers">字母+数字</option>
                                            <option value="numbers_letters">数字+字母</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 数字部分设置 -->
                                    <div id="numberSettings" class="config-group" style="background: #f0f9ff;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">
                                                    数字部分
                                                </label>
                                                <select id="numberMode" class="input-field" onchange="updatePatternOptions()">
                                                    <option value="random">随机数字</option>
                                                    <option value="pattern">规律模式</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">
                                                    数字长度
                                                </label>
                                                <input type="number" id="numberLength" min="1" max="10" value="3"
                                                       class="input-field input-number">
                                                <span class="form-hint" id="numberLengthHint">设置数字部分的长度</span>
                                            </div>
                                        </div>
                                        
                                        <!-- 规律模式选项 -->
                                        <div id="patternOptions" class="form-row" style="display: none;">
                                            <div class="form-group">
                                                <label class="form-label">
                                                    规律模式
                                                </label>
                                                <select id="patternType" class="input-field" onchange="updatePatternOptions()">
                                                    <option value="student_id">学号模式</option>
                                                    <option value="date">日期模式</option>
                                                    <option value="incremental">递增模式</option>
                                                </select>
                                            </div>
                                            <div class="form-group" id="startValueGroup">
                                                <label class="form-label">
                                                    起始值 <span class="text-red-500">*</span>
                                                </label>
                                                <input type="text" id="startValue" value="1001"
                                                       class="input-field">
                                                <span class="form-hint" id="startValueHint">学号/递增起始值，决定数字长度</span>
                                            </div>
                                        </div>
                                        
                                        <!-- 总长度预览 -->
                                        <div id="totalLengthPreview" class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
                                            <span class="font-medium text-blue-800">总长度预览：</span>
                                            <span id="totalLengthText" class="text-blue-600">基础长度(6) + 数字长度(3) = 9位</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 字符类型选择 -->
                                    <div>
                                        <label class="form-label">
                                            字符类型选择
                                        </label>
                                        <div id="characterTypes" class="checkbox-group">
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="includeUsernameUppercase" checked
                                                       class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                                <span>包含大写字母</span>
                                            </label>
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="includeUsernameLowercase" checked
                                                       class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                                <span>包含小写字母</span>
                                            </label>
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="includeUsernameNumbers" checked
                                                       class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                                <span>包含数字</span>
                                            </label>
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="includeUsernameSymbols" 
                                                       class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                                <span>包含特殊符号</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        密码长度
                                    </label>
                                    <select id="passwordLength" class="input-field">
                                        <option value="8">8位</option>
                                        <option value="10" selected>10位</option>
                                        <option value="12">12位</option>
                                        <option value="16">16位</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        权限角色
                                    </label>
                                    <input type="text" id="roleName" 
                                           class="input-field"
                                           placeholder="可选，不填使用默认角色">
                                </div>
                            </div>
                            
                            <div class="config-group">
                                <div class="config-header">
                                    <div class="config-title">
                                        <i class="fa fa-shield"></i>
                                        密码安全设置
                                    </div>
                                </div>
                                
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="includeUppercase" checked
                                               class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                        <span>包含大写字母</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="includeLowercase" checked
                                               class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                        <span>包含小写字母</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="includeNumbers" checked
                                               class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                        <span>包含数字</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="includeSymbols" 
                                               class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                        <span>包含特殊符号</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="startRegisterBtn" 
                                    class="btn-primary"
                                    onclick="startRegistration()">
                                <i class="fa fa-play mr-2"></i>
                                开始注册
                            </button>
                            <button id="resetBtn" 
                                    class="btn-secondary"
                                    onclick="resetForm()">
                                <i class="fa fa-bullseye mr-2"></i>
                                重置设置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 侧边栏 -->
                <div class="space-y-6">
                    <!-- 进度 -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fa fa-spinner mr-2 text-primary"></i>
                            注册进度
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                            
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="progressText">0/0</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            
                            <div id="statusMessage" class="text-sm text-gray-600 bg-gray-50 rounded-lg p-4">
                                请先配置API并生成Token
                            </div>
                        </div>
                    </div>

                    <!-- 最近结果 -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fa fa-list mr-2 text-primary"></i>
                            最近结果
                        </h3>
                        
                        <div id="recentResults" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fa fa-inbox text-4xl mb-2 opacity-50"></i>
                                <p class="text-sm">暂无注册记录</p>
                            </div>
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 16px;">
                            <button id="exportBtn" 
                                    class="btn-primary" 
                                    onclick="exportResults()" disabled>
                                <i class="fa fa-download mr-2"></i>
                                导出
                            </button>
                            <button id="clearBtn" 
                                    class="btn-secondary" 
                                    onclick="clearResults()" disabled>
                                <i class="fa fa-trash mr-2"></i>
                                清空
                            </button>
                        </div>
                    </div>

                    <!-- 系统日志 -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fa fa-terminal mr-2 text-primary"></i>
                            系统日志
                        </h3>
                        
                        <div id="systemLogs" class="text-sm text-gray-600 space-y-2 max-h-48 overflow-y-auto">
                            <div class="log-entry">
                                <span class="text-gray-400">[系统]</span>
                                <span>系统已启动，准备就绪</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 详细记录 -->
            <div class="card p-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fa fa-table mr-2 text-primary"></i>
                        详细注册记录
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <input type="text" id="searchInput" placeholder="搜索邮箱..."
                               class="input-field">
                        <select id="filterSelect" 
                                class="input-field">
                            <option value="all">全部状态</option>
                            <option value="success">注册成功</option>
                            <option value="failed">注册失败</option>
                        </select>
                        <button id="deleteAllBtn" 
                                class="btn-danger" 
                                onclick="confirmDeleteAll()" disabled>
                            <i class="fa fa-trash mr-2"></i>
                            删除全部
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">序号</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">邮箱地址</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">密码</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">状态</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">时间</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">
                                    <i class="fa fa-search text-4xl mb-2 opacity-50"></i>
                                    <p>暂无数据</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <!-- 加载模态框 -->
    <div id="loadingModal" class="modal">
        <div class="modal-content p-8 text-center">
            <div class="inline-block p-4 bg-blue-50 rounded-full mb-4">
                <div class="loading-spinner mx-auto"></div>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">正在处理</h3>
            <p id="loadingMessage" class="text-gray-600">请稍候...</p>
            <div class="mt-4 progress-bar">
                <div id="loadingProgress" class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- 成功模态框 -->
    <div id="successModal" class="modal">
        <div class="modal-content p-8 text-center">
            <div class="inline-block p-4 bg-green-50 rounded-full mb-4">
                <i class="fa fa-check text-green-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">操作成功</h3>
            <p id="successMessage" class="text-gray-600 mb-6">批量注册完成！</p>
            <div class="action-buttons">
                <button class="btn-primary" onclick="hideModal('successModal')">
                    确定
                </button>
                <button class="btn-secondary" onclick="exportResults(); hideModal('successModal')">
                    导出结果
                </button>
            </div>
        </div>
    </div>

    <!-- 错误模态框 -->
    <div id="errorModal" class="modal">
        <div class="modal-content p-8 text-center">
            <div class="inline-block p-4 bg-red-50 rounded-full mb-4">
                <i class="fa fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">操作失败</h3>
            <p id="errorMessage" class="text-gray-600 mb-6">请检查网络连接后重试</p>
            <button class="btn-primary" onclick="hideModal('errorModal')">
                确定
            </button>
        </div>
    </div>

    <!-- Token历史模态框 -->
    <div id="tokenHistoryModal" class="modal">
        <div class="modal-content p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Token历史记录</h3>
                <button onclick="hideModal('tokenHistoryModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="security-tip mb-4">
                <i class="fa fa-info-circle mr-2"></i>
                Token历史记录已加密存储在本地，仅用于您的方便使用
            </div>
            
            <div id="tokenHistoryList" class="space-y-3">
                <!-- Token历史记录将在这里显示 -->
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="clearTokenHistoryBtn" 
                        class="w-full btn-secondary"
                        onclick="clearTokenHistory()">
                    <i class="fa fa-trash mr-2"></i>清空历史记录
                </button>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content p-8 text-center">
            <div class="inline-block p-4 bg-red-50 rounded-full mb-4">
                <i class="fa fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
            <p id="confirmDeleteMessage" class="text-gray-600 mb-6">确定要删除所有注册记录吗？此操作不可撤销！</p>
            <div class="action-buttons">
                <button class="btn-primary" onclick="hideModal('confirmDeleteModal')">
                    取消
                </button>
                <button class="btn-danger" onclick="deleteAllRecords()">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="modal">
        <div class="modal-content p-8 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">使用帮助</h3>
                <button onclick="hideModal('helpModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6 text-sm">
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">1. API配置</h4>
                    <p class="text-gray-600">请正确填写API域名、管理员邮箱和密码，然后点击"生成Token"获取访问令牌。Token生成后会自动保存，下次使用时可以直接从历史记录中加载。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">2. Token安全</h4>
                    <p class="text-gray-600">Token默认加密显示，点击眼睛图标可临时查看完整内容。所有Token历史记录都加密存储在本地，确保您的信息安全。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">3. 用户名配置</h4>
                    <ul class="text-gray-600 space-y-1">
                        <li>• 基础长度：字母部分的长度（1-20位）</li>
                        <li>• 数字长度：数字部分的长度（1-10位）</li>
                        <li>• 总长度 = 基础长度 + 数字长度</li>
                        <li>• 生成模式：
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>完全随机：纯随机字符组合（基础长度即为总长度）</li>
                                <li>字母+数字：字母开头，数字结尾（总长度=基础长度+数字长度）</li>
                                <li>数字+字母：数字开头，字母结尾（总长度=数字长度+基础长度）</li>
                            </ul>
                        </li>
                        <li>• 规律模式说明：
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>学号模式：需要设置起始值，按顺序递增</li>
                                <li>日期模式：使用当前日期，不需要起始值</li>
                                <li>递增模式：需要设置起始值，简单递增</li>
                            </ul>
                        </li>
                        <li>• 前缀支持：可选，会添加在最前面</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">4. 密码安全</h4>
                    <p class="text-gray-600">密码在界面中默认加密显示，点击复制按钮可以复制完整密码。导出CSV文件时会显示完整密码。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">5. 数据管理</h4>
                    <p class="text-gray-600">可以通过"删除全部"按钮一次性删除所有注册记录，也可以通过每条记录后面的删除按钮单独删除。所有操作都会立即生效并保存到本地存储。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">6. 常见问题</h4>
                    <ul class="text-gray-600 space-y-1">
                        <li>• Token生成失败：检查网络连接和API配置</li>
                        <li>• 注册失败：检查Token是否有效，API是否正常</li>
                        <li>• 网络问题：确保设备网络连接正常</li>
                        <li>• 安全提示：请勿在公共设备上保存敏感信息</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast通知 -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        // 全局变量
        let registeredAccounts = [];
        let tokenHistory = [];
        let isRegistering = false;
        let tokenVisible = false;
        let originalToken = '';

        // 初始化函数
        function init() {
            try {
                console.log('系统初始化开始...');
                
                // 加载保存的数据
                loadData();
                
                // 更新界面
                updateDashboard();
                updateResultsTable();
                updateButtonStates();
                updatePatternOptions(); // 初始化模式选项
                updateTotalLengthPreview(); // 初始化总长度预览
                
                // 添加事件监听器
                document.getElementById('searchInput').addEventListener('input', filterResults);
                document.getElementById('filterSelect').addEventListener('change', filterResults);
                document.getElementById('helpBtn').addEventListener('click', () => showModal('helpModal'));
                
                // 添加长度变化监听器
                document.getElementById('usernameLength').addEventListener('input', updateTotalLengthPreview);
                document.getElementById('numberLength').addEventListener('input', updateTotalLengthPreview);
                document.getElementById('startValue').addEventListener('input', () => {
                    updateNumberLengthFromStartValue();
                    updateTotalLengthPreview();
                });
                
                // 点击模态框外部关闭
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        hideAllModals();
                    }
                });
                
                console.log('系统初始化完成');
                log('系统', '系统已启动，准备就绪');
                
            } catch (error) {
                console.error('初始化失败:', error);
                showError('系统初始化失败，请刷新页面重试');
                log('错误', `初始化失败: ${error.message}`);
            }
        }

        // 加载数据
        function loadData() {
            try {
                // 加载注册记录
                const savedAccounts = localStorage.getItem('registeredAccounts');
                if (savedAccounts) {
                    registeredAccounts = JSON.parse(savedAccounts);
                    console.log(`加载了 ${registeredAccounts.length} 条注册记录`);
                }
                
                // 加载Token历史
                const savedTokenHistory = localStorage.getItem('tokenHistory');
                if (savedTokenHistory) {
                    tokenHistory = JSON.parse(savedTokenHistory);
                    console.log(`加载了 ${tokenHistory.length} 条Token记录`);
                }
                
                // 加载表单数据
                const savedFormData = localStorage.getItem('formData');
                if (savedFormData) {
                    const formData = JSON.parse(savedFormData);
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (key === 'accessToken' && formData[key]) {
                                // Token需要特殊处理，加密显示
                                originalToken = formData[key];
                                element.value = maskToken(formData[key]);
                            } else {
                                element.value = formData[key];
                            }
                        }
                    });
                    console.log('表单数据加载完成');
                }
                
                // 设置默认值
                if (!document.getElementById('usernameLength').value) {
                    document.getElementById('usernameLength').value = '6';
                }
                if (!document.getElementById('numberLength').value) {
                    document.getElementById('numberLength').value = '3';
                }
                if (!document.getElementById('startValue').value) {
                    document.getElementById('startValue').value = '1001';
                }
                
            } catch (error) {
                console.error('数据加载失败:', error);
                log('错误', `数据加载失败: ${error.message}`);
            }
        }

        // 保存数据
        function saveData() {
            try {
                localStorage.setItem('registeredAccounts', JSON.stringify(registeredAccounts));
                localStorage.setItem('tokenHistory', JSON.stringify(tokenHistory));
                
                // 保存表单数据
                const formData = {
                    apiDomain: document.getElementById('apiDomain').value,
                    accessToken: originalToken, // 保存原始Token，不保存加密后的
                    adminEmail: document.getElementById('adminEmail').value,
                    emailDomain: document.getElementById('emailDomain').value,
                    usernamePrefix: document.getElementById('usernamePrefix').value,
                    usernameLength: document.getElementById('usernameLength').value,
                    generationMode: document.getElementById('generationMode').value,
                    numberMode: document.getElementById('numberMode').value,
                    numberLength: document.getElementById('numberLength').value,
                    patternType: document.getElementById('patternType').value,
                    startValue: document.getElementById('startValue').value,
                    roleName: document.getElementById('roleName').value
                };
                localStorage.setItem('formData', JSON.stringify(formData));
                
            } catch (error) {
                console.error('数据保存失败:', error);
                log('错误', `数据保存失败: ${error.message}`);
            }
        }

        // Token加密显示
        function maskToken(token) {
            if (!token) return '';
            if (token.length <= 8) {
                return token.substring(0, 2) + '***' + token.substring(token.length - 2);
            }
            return token.substring(0, 4) + '********' + token.substring(token.length - 4);
        }

        // 密码加密显示
        function maskPassword(password) {
            if (!password) return '';
            return '••••••••'; // 固定显示8个点
        }

        // 切换Token可见性
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('accessToken');
            const toggleIcon = document.getElementById('toggleTokenIcon');
            
            if (tokenVisible) {
                // 隐藏Token，显示加密版本
                tokenInput.value = maskToken(originalToken);
                toggleIcon.className = 'fa fa-eye-slash';
                tokenVisible = false;
                setTimeout(() => {
                    showToast('Token已隐藏');
                }, 100);
            } else {
                // 显示完整Token
                tokenInput.value = originalToken || '';
                toggleIcon.className = 'fa fa-eye';
                tokenVisible = true;
                showToast('Token显示10秒后将自动隐藏');
                
                // 10秒后自动隐藏
                setTimeout(() => {
                    if (tokenVisible) {
                        toggleTokenVisibility();
                    }
                }, 10000);
            }
        }

        // 生成Token
        async function generateToken() {
            try {
                const apiDomain = document.getElementById('apiDomain').value.trim();
                const adminEmail = document.getElementById('adminEmail').value.trim();
                const adminPassword = document.getElementById('adminPassword').value.trim();
                
                if (!apiDomain || !adminEmail || !adminPassword) {
                    showError('请填写完整的API配置信息');
                    return;
                }
                
                if (!apiDomain.startsWith('http://') && !apiDomain.startsWith('https://')) {
                    showError('API域名必须以http://或https://开头');
                    return;
                }
                
                showLoading('正在生成Token...');
                
                try {
                    const response = await fetch(`${apiDomain}/api/public/genToken`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: adminEmail, password: adminPassword })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText || '请求失败'}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 200 && data.data && data.data.token) {
                        originalToken = data.data.token;
                        document.getElementById('accessToken').value = maskToken(originalToken);
                        updateApiStatus(true);
                        
                        // 保存到历史记录
                        saveTokenToHistory({
                            token: originalToken,
                            apiDomain: apiDomain,
                            adminEmail: adminEmail,
                            timestamp: new Date().toLocaleString()
                        });
                        
                        hideModal('loadingModal');
                        showSuccess('Token生成成功！已加密显示');
                        log('系统', 'Token生成成功');
                        saveData();
                    } else {
                        throw new Error(data.message || 'Token生成失败，返回数据格式不正确');
                    }
                    
                } catch (networkError) {
                    console.error('Token生成网络错误:', networkError);
                    
                    // 详细的错误信息
                    let errorMessage = 'Token生成失败: ';
                    
                    if (networkError.message.includes('Failed to fetch')) {
                        errorMessage += '网络连接失败，请检查：\n1. API域名是否正确\n2. 网络连接是否正常\n3. 是否有防火墙或VPN限制\n4. CORS跨域设置是否正确';
                    } else if (networkError.message.includes('HTTP 404')) {
                        errorMessage += 'API接口不存在，请确认API域名正确';
                    } else if (networkError.message.includes('HTTP 401')) {
                        errorMessage += '身份验证失败，请检查管理员邮箱和密码';
                    } else if (networkError.message.includes('HTTP 500')) {
                        errorMessage += '服务器内部错误，请联系API提供商';
                    } else {
                        errorMessage += networkError.message;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('Token生成失败:', error);
                hideModal('loadingModal');
                showError(error.message);
                log('错误', `Token生成失败: ${error.message}`);
            }
        }

        // 保存Token到历史记录
        function saveTokenToHistory(tokenInfo) {
            try {
                tokenHistory.unshift(tokenInfo);
                if (tokenHistory.length > 10) {
                    tokenHistory = tokenHistory.slice(0, 10);
                }
                saveData();
            } catch (error) {
                console.error('Token历史保存失败:', error);
            }
        }

        // 显示Token历史记录
        function showTokenHistory() {
            const tokenHistoryList = document.getElementById('tokenHistoryList');
            tokenHistoryList.innerHTML = '';
            
            if (tokenHistory.length === 0) {
                tokenHistoryList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fa fa-clock-o text-4xl mb-2 opacity-50"></i>
                        <p class="text-sm">暂无Token历史记录</p>
                    </div>
                `;
            } else {
                tokenHistory.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-primary transition-colors cursor-pointer';
                    historyItem.onclick = () => selectTokenFromHistory(item);
                    
                    historyItem.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900 truncate" title="${item.token}">
                                    ${maskToken(item.token)}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">${item.adminEmail}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400">${item.timestamp}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 truncate" title="${item.apiDomain}">
                            ${item.apiDomain}
                        </p>
                    `;
                    
                    tokenHistoryList.appendChild(historyItem);
                });
            }
            
            showModal('tokenHistoryModal');
        }

        // 从历史记录选择Token
        function selectTokenFromHistory(tokenInfo) {
            document.getElementById('apiDomain').value = tokenInfo.apiDomain;
            originalToken = tokenInfo.token;
            document.getElementById('accessToken').value = maskToken(originalToken);
            document.getElementById('adminEmail').value = tokenInfo.adminEmail;
            
            updateApiStatus(true);
            hideModal('tokenHistoryModal');
            saveData();
            log('系统', '从历史记录加载Token成功');
            showToast('Token已加载成功（已加密显示）');
        }

        // 清空Token历史记录
        function clearTokenHistory() {
            if (confirm('确定要清空所有Token历史记录吗？')) {
                tokenHistory = [];
                saveData();
                showTokenHistory();
                log('系统', 'Token历史记录已清空');
            }
        }

        // 复制Token
        function copyToken() {
            if (originalToken) {
                navigator.clipboard.writeText(originalToken).then(() => {
                    showToast('Token已复制到剪贴板');
                    
                    // 显示复制成功的视觉反馈
                    const copyBtn = document.getElementById('copyTokenBtn');
                    const originalIcon = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fa fa-check"></i>';
                    copyBtn.style.color = '#10B981';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalIcon;
                        copyBtn.style.color = '';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('复制失败:', err);
                    showToast('复制失败，请手动复制');
                });
            } else {
                showToast('没有Token可复制');
            }
        }

        // 更新模式选项显示 - 优化日期模式
        function updatePatternOptions() {
            const generationMode = document.getElementById('generationMode').value;
            const numberSettings = document.getElementById('numberSettings');
            const patternOptions = document.getElementById('patternOptions');
            const numberMode = document.getElementById('numberMode').value;
            const numberLength = document.getElementById('numberLength');
            const numberLengthHint = document.getElementById('numberLengthHint');
            const startValue = document.getElementById('startValue');
            const startValueGroup = document.getElementById('startValueGroup');
            const startValueHint = document.getElementById('startValueHint');
            const patternType = document.getElementById('patternType').value;
            
            // 根据生成模式显示/隐藏数字设置
            if (generationMode === 'letters_numbers' || generationMode === 'numbers_letters') {
                numberSettings.style.display = 'block';
            } else {
                numberSettings.style.display = 'none';
            }
            
            // 根据数字模式更新数字长度的可用性和提示
            if (numberMode === 'pattern') {
                patternOptions.style.display = 'flex';
                
                // 根据规律模式类型更新起始值的显示
                if (patternType === 'date') {
                    // 日期模式：隐藏起始值输入框
                    startValueGroup.style.display = 'none';
                    // 日期模式的数字长度固定为8位（年月日+序号）
                    numberLength.value = 8;
                    numberLength.disabled = true;
                    numberLengthHint.textContent = '日期模式固定8位（年月日+序号）';
                } else {
                    // 其他规律模式：显示起始值输入框
                    startValueGroup.style.display = 'block';
                    numberLength.disabled = true;
                    numberLengthHint.textContent = '规律模式下数字长度由起始值决定';
                    
                    // 更新起始值提示
                    if (patternType === 'student_id') {
                        startValueHint.textContent = '学号起始值，决定数字长度';
                    } else { // incremental
                        startValueHint.textContent = '递增起始值，决定数字长度';
                    }
                    
                    // 根据起始值自动设置数字长度
                    if (startValue.value) {
                        numberLength.value = startValue.value.length;
                    }
                }
            } else {
                patternOptions.style.display = 'none';
                numberLength.disabled = false;
                numberLengthHint.textContent = '设置数字部分的长度';
            }
            
            // 更新字符类型选项
            updateCharacterTypeOptions();
            
            // 更新总长度预览
            updateTotalLengthPreview();
        }

        // 更新字符类型选项
        function updateCharacterTypeOptions() {
            const generationMode = document.getElementById('generationMode').value;
            const includeNumbers = document.getElementById('includeUsernameNumbers');
            
            // 根据生成模式自动勾选或禁用数字选项
            switch (generationMode) {
                case 'letters_numbers':
                case 'numbers_letters':
                    includeNumbers.checked = true;
                    includeNumbers.disabled = true;
                    break;
                default: // random
                    includeNumbers.disabled = false;
                    break;
            }
        }

        // 监听起始值变化，自动更新数字长度
        function updateNumberLengthFromStartValue() {
            const startValue = document.getElementById('startValue').value;
            const numberLength = document.getElementById('numberLength');
            const numberMode = document.getElementById('numberMode').value;
            const patternType = document.getElementById('patternType').value;
            
            if (numberMode === 'pattern' && patternType !== 'date' && startValue) {
                numberLength.value = startValue.length;
            }
        }

        // 更新总长度预览
        function updateTotalLengthPreview() {
            const generationMode = document.getElementById('generationMode').value;
            const usernameLength = parseInt(document.getElementById('usernameLength').value) || 0;
            const numberLength = parseInt(document.getElementById('numberLength').value) || 0;
            const totalLengthPreview = document.getElementById('totalLengthPreview');
            const totalLengthText = document.getElementById('totalLengthText');
            const patternType = document.getElementById('patternType').value;
            
            if (generationMode === 'letters_numbers' || generationMode === 'numbers_letters') {
                const totalLength = usernameLength + numberLength;
                
                if (patternType === 'date') {
                    totalLengthText.textContent = `基础长度(${usernameLength}) + 日期(8位) = ${totalLength}位`;
                } else {
                    totalLengthText.textContent = `基础长度(${usernameLength}) + 数字长度(${numberLength}) = ${totalLength}位`;
                }
                
                totalLengthPreview.style.display = 'block';
            } else if (generationMode === 'random') {
                totalLengthText.textContent = `总长度 = 基础长度(${usernameLength})`;
                totalLengthPreview.style.display = 'block';
            } else {
                totalLengthPreview.style.display = 'none';
            }
        }

        // 获取用户名配置
        function getUsernameConfig() {
            const includeUppercase = document.getElementById('includeUsernameUppercase').checked;
            const includeLowercase = document.getElementById('includeUsernameLowercase').checked;
            const includeNumbers = document.getElementById('includeUsernameNumbers').checked;
            const includeSymbols = document.getElementById('includeUsernameSymbols').checked;
            const generationMode = document.getElementById('generationMode').value;
            
            // 根据生成模式自动调整配置
            let effectiveConfig = {
                includeUppercase: includeUppercase,
                includeLowercase: includeLowercase,
                includeNumbers: includeNumbers,
                includeSymbols: includeSymbols,
                generationMode: generationMode,
                numberMode: document.getElementById('numberMode').value,
                numberLength: parseInt(document.getElementById('numberLength').value) || 0,
                patternType: document.getElementById('patternType').value,
                startValue: document.getElementById('startValue').value
            };
            
            // 验证配置
            if (generationMode === 'letters_numbers' || generationMode === 'numbers_letters') {
                effectiveConfig.includeNumbers = true;
            }
            
            // 验证至少选择一种字符类型
            let hasLetters = effectiveConfig.includeUppercase || effectiveConfig.includeLowercase;
            let hasNumbers = effectiveConfig.includeNumbers;
            
            if (generationMode === 'letters_numbers') {
                if (!hasLetters) {
                    return {
                        valid: false,
                        error: '请至少选择一种字母类型（大写或小写）'
                    };
                }
            } else if (generationMode === 'numbers_letters') {
                if (!hasNumbers || !hasLetters) {
                    return {
                        valid: false,
                        error: '数字+字母模式需要同时选择字母和数字'
                    };
                }
            } else if (!hasLetters && !hasNumbers && !effectiveConfig.includeSymbols) {
                return {
                    valid: false,
                    error: '请至少选择一种字符类型'
                };
            }
            
            // 验证规律模式的起始值（除了日期模式）
            if (effectiveConfig.numberMode === 'pattern' && 
                effectiveConfig.patternType !== 'date' && 
                !effectiveConfig.startValue) {
                return {
                    valid: false,
                    error: '规律模式需要设置起始值'
                };
            }
            
            return {
                valid: true,
                ...effectiveConfig
            };
        }

        // 生成规律数字 - 优化日期模式
        function generatePatternNumber(patternType, index) {
            switch (patternType) {
                case 'student_id':
                    // 学号模式：固定长度，前面补0
                    const startValue = document.getElementById('startValue').value;
                    const startNum = parseInt(startValue);
                    const currentValue = startNum + index;
                    const numberLength = startValue.length;
                    return currentValue.toString().padStart(numberLength, '0');
                    
                case 'date':
                    // 日期模式：年+月+日+序号（不需要起始值）
                    const date = new Date();
                    const year = date.getFullYear().toString().substr(-2);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    // 序号部分从1开始，3位数字
                    const sequence = (index + 1).toString().padStart(3, '0');
                    return year + month + day + sequence;
                    
                case 'incremental':
                default:
                    // 递增模式：简单递增数字
                    const startNum2 = parseInt(document.getElementById('startValue').value);
                    const currentValue2 = startNum2 + index;
                    return currentValue2.toString();
            }
        }

        // 生成随机字母
        function generateRandomLetters(length, includeUppercase, includeLowercase) {
            let charset = '';
            if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            
            if (charset === '') {
                charset = 'abcdefghijklmnopqrstuvwxyz'; // 默认小写字母
            }
            
            let result = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                result += charset[randomIndex];
            }
            
            return result;
        }

        // 生成随机数字
        function generateRandomNumbers(length) {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += Math.floor(Math.random() * 10).toString();
            }
            return result;
        }

        // 生成用户名
        function generateUsername(prefix, baseLength, index = 0) {
            const config = getUsernameConfig();
            const generationMode = config.generationMode;
            
            let username = '';
            
            switch (generationMode) {
                case 'letters_numbers':
                    // 字母+数字模式：基础长度是字母部分，数字部分额外添加
                    const letters = generateRandomLetters(baseLength, 
                        config.includeUppercase, config.includeLowercase);
                    let numbers = '';
                    
                    if (config.numberMode === 'pattern') {
                        numbers = generatePatternNumber(config.patternType, index);
                    } else {
                        numbers = generateRandomNumbers(config.numberLength);
                    }
                    
                    username = letters + numbers;
                    break;
                    
                case 'numbers_letters':
                    // 数字+字母模式：数字部分 + 基础长度的字母部分
                    let numbers2 = '';
                    if (config.numberMode === 'pattern') {
                        numbers2 = generatePatternNumber(config.patternType, index);
                    } else {
                        numbers2 = generateRandomNumbers(config.numberLength);
                    }
                    const letters2 = generateRandomLetters(baseLength, 
                        config.includeUppercase, config.includeLowercase);
                    
                    username = numbers2 + letters2;
                    break;
                    
                case 'random':
                default:
                    // 完全随机模式：基础长度即为总长度
                    username = generateRandomUsername(config, baseLength);
                    break;
            }
            
            // 如果有前缀，添加前缀
            if (prefix) {
                username = prefix + username;
            }
            
            return username;
        }

        // 完全随机用户名生成
        function generateRandomUsername(config, length) {
            let charset = '';
            if (config.includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (config.includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (config.includeNumbers) charset += '0123456789';
            if (config.includeSymbols) charset += '!@#$%^&*()_+{}[]|:;<>,.?/~`-=';
            
            if (charset === '') {
                charset = 'abcdefghijklmnopqrstuvwxyz0123456789';
            }
            
            let result = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                result += charset[randomIndex];
            }
            
            return result;
        }

        // 生成密码
        function generatePassword() {
            const length = parseInt(document.getElementById('passwordLength').value);
            let charset = '';
            
            if (document.getElementById('includeUppercase').checked) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (document.getElementById('includeLowercase').checked) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (document.getElementById('includeNumbers').checked) charset += '0123456789';
            if (document.getElementById('includeSymbols').checked) charset += '!@#$%^&*()_+{}[]|:;<>,.?/~`-=';
            
            if (charset === '') {
                charset = 'abcdefghijklmnopqrstuvwxyz0123456789';
            }
            
            let password = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                password += charset[randomIndex];
            }
            
            return password;
        }

        // 开始注册
        async function startRegistration() {
            if (isRegistering) {
                showError('注册正在进行中，请稍候...');
                return;
            }
            
            try {
                const apiDomain = document.getElementById('apiDomain').value.trim();
                const accessToken = originalToken;
                const emailDomain = document.getElementById('emailDomain').value.trim();
                const registerCount = parseInt(document.getElementById('registerCount').value);
                const usernamePrefix = document.getElementById('usernamePrefix').value.trim();
                const roleName = document.getElementById('roleName').value.trim();
                const usernameLength = parseInt(document.getElementById('usernameLength').value);
                
                if (!apiDomain || !accessToken || !emailDomain) {
                    showError('请填写完整的API配置和注册信息');
                    return;
                }
                
                if (isNaN(registerCount) || registerCount < 1 || registerCount > 100) {
                    showError('注册数量必须在1-100之间');
                    return;
                }
                
                if (isNaN(usernameLength) || usernameLength < 1 || usernameLength > 20) {
                    showError('基础长度必须在1-20之间');
                    return;
                }
                
                // 验证用户名配置
                const usernameConfig = getUsernameConfig();
                if (!usernameConfig.valid) {
                    showError(usernameConfig.error);
                    return;
                }
                
                // 设置状态为正在注册
                isRegistering = true;
                updateButtonStates();
                showLoading('正在批量注册邮箱账号...');
                
                const startTime = Date.now();
                const successfulAccounts = [];
                const failedAccounts = [];
                
                try {
                    for (let i = 0; i < registerCount; i++) {
                        const progress = ((i + 1) / registerCount) * 100;
                        updateLoadingProgress(progress);
                        updateProgress(i + 1, registerCount);
                        
                        const username = generateUsername(usernamePrefix, usernameLength, i);
                        const email = `${username}@${emailDomain}`;
                        const password = generatePassword();
                        
                        try {
                            // 模拟API调用延迟
                            await new Promise(resolve => setTimeout(resolve, 800));
                            
                            const success = await registerAccount(apiDomain, accessToken, email, password, roleName);
                            
                            if (success) {
                                const account = {
                                    id: Date.now() + i,
                                    email: email,
                                    password: password,
                                    status: 'success',
                                    timestamp: new Date().toLocaleString()
                                };
                                successfulAccounts.push(account);
                                registeredAccounts.unshift(account);
                                addRecentResult(account, 'success');
                                log('成功', `邮箱 ${email} 注册成功`);
                            } else {
                                throw new Error('注册失败');
                            }
                            
                        } catch (error) {
                            const account = {
                                id: Date.now() + i,
                                email: email,
                                password: password,
                                status: 'failed',
                                error: error.message,
                                timestamp: new Date().toLocaleString()
                            };
                            failedAccounts.push(account);
                            registeredAccounts.unshift(account);
                            addRecentResult(account, 'failed');
                            log('失败', `邮箱 ${email} 注册失败: ${error.message}`);
                        }
                        
                        // 更新状态消息
                        updateStatusMessage(`正在注册第 ${i + 1}/${registerCount} 个账号`);
                    }
                    
                    const endTime = Date.now();
                    const totalTime = (endTime - startTime) / 1000;
                    
                    // 保存数据并更新界面
                    saveData();
                    updateDashboard();
                    updateResultsTable();
                    
                    // 显示成功消息
                    hideModal('loadingModal');
                    showSuccess(
                        `批量注册完成！\n成功: ${successfulAccounts.length} 个\n失败: ${failedAccounts.length} 个\n总耗时: ${totalTime.toFixed(1)} 秒`,
                        successfulAccounts.length > 0
                    );
                    
                    log('系统', `批量注册完成，成功 ${successfulAccounts.length} 个，失败 ${failedAccounts.length} 个`);
                    
                } finally {
                    // 确保无论成功还是失败都重置状态
                    isRegistering = false;
                    updateButtonStates();
                    updateProgress(0, 0);
                    updateStatusMessage('准备就绪，可以开始新的注册任务');
                }
                
            } catch (error) {
                console.error('注册过程失败:', error);
                // 确保在错误情况下也重置状态
                isRegistering = false;
                updateButtonStates();
                hideModal('loadingModal');
                showError(`注册过程中发生错误: ${error.message}`);
                log('错误', `批量注册失败: ${error.message}`);
                updateProgress(0, 0);
                updateStatusMessage('准备就绪，可以开始新的注册任务');
            }
        }

        // 注册单个账号
        async function registerAccount(apiDomain, token, email, password, roleName) {
            try {
                const requestData = {
                    list: [{
                        email: email,
                        password: password
                    }]
                };
                
                if (roleName) {
                    requestData.list[0].roleName = roleName;
                }
                
                const response = await fetch(`${apiDomain}/api/public/addUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || '请求失败'}`);
                }
                
                const data = await response.json();
                return data.code === 200;
                
            } catch (error) {
                console.error('账号注册失败:', error);
                throw error;
            }
        }

        // 更新进度
        function updateProgress(current, total) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${current}/${total}`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
        }

        // 更新加载进度
        function updateLoadingProgress(percent) {
            const loadingProgress = document.getElementById('loadingProgress');
            if (loadingProgress) {
                loadingProgress.style.width = `${percent}%`;
            }
        }

        // 更新状态消息
        function updateStatusMessage(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        // 更新API状态
        function updateApiStatus(connected) {
            const apiStatusBadge = document.getElementById('apiStatusBadge');
            if (connected) {
                apiStatusBadge.className = 'badge badge-success';
                apiStatusBadge.textContent = '已连接';
            } else {
                apiStatusBadge.className = 'badge badge-warning';
                apiStatusBadge.textContent = '未连接';
            }
        }

        // 添加最近结果
        function addRecentResult(account, status) {
            const recentResults = document.getElementById('recentResults');
            
            // 如果是第一条记录，清空占位符
            if (recentResults.children.length === 1 && recentResults.children[0].textContent.includes('暂无注册记录')) {
                recentResults.innerHTML = '';
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = `flex items-center justify-between p-3 rounded-lg ${
                status === 'success' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'
            }`;
            
            resultItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${
                        status === 'success' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                    }">
                        <i class="fa fa-${status === 'success' ? 'check' : 'times'} text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium ${status === 'success' ? 'text-green-800' : 'text-red-800'}">${account.email}</p>
                        <p class="text-xs ${status === 'success' ? 'text-green-600' : 'text-red-600'}">${maskPassword(account.password)}</p>
                    </div>
                </div>
                <span class="text-xs ${status === 'success' ? 'text-green-600' : 'text-red-600'}">
                    ${account.timestamp.split(' ')[1]}
                </span>
            `;
            
            recentResults.insertBefore(resultItem, recentResults.firstChild);
            
            // 限制显示最近10条记录
            while (recentResults.children.length > 10) {
                recentResults.removeChild(recentResults.lastChild);
            }
        }

        // 更新仪表板
        function updateDashboard() {
            const today = new Date().toLocaleDateString();
            const todayAccounts = registeredAccounts.filter(account => 
                account.timestamp.startsWith(today)
            );
            
            const totalSuccess = registeredAccounts.filter(account => account.status === 'success').length;
            const totalAttempted = registeredAccounts.length;
            const successRate = totalAttempted > 0 ? Math.round((totalSuccess / totalAttempted) * 100) : 0;
            
            document.getElementById('todayCount').textContent = todayAccounts.length;
            document.getElementById('totalCount').textContent = totalSuccess;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // 更新API状态
            updateApiStatus(!!originalToken);
        }

        // 更新结果表格
        function updateResultsTable() {
            const filteredAccounts = getFilteredAccounts();
            const resultsTable = document.getElementById('resultsTable');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            
            if (filteredAccounts.length === 0) {
                resultsTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fa fa-search text-4xl mb-2 opacity-50"></i>
                            <p>暂无数据</p>
                        </td>
                    </tr>
                `;
                deleteAllBtn.disabled = true;
                return;
            }
            
            resultsTable.innerHTML = '';
            filteredAccounts.forEach((account, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-600">${index + 1}</td>
                    <td class="py-3 px-4 font-medium text-gray-900">${account.email}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600 password-masked">${maskPassword(account.password)}</span>
                            <button onclick="copyText('${account.password}')" 
                                    class="text-primary hover:text-primary/80 text-sm copy-btn">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="badge ${account.status === 'success' ? 'badge-success' : 'badge-error'}">
                            ${account.status === 'success' ? '注册成功' : '注册失败'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-gray-600 text-sm">${account.timestamp}</td>
                    <td class="py-3 px-4">
                        <button onclick="copyAccountInfo('${account.email}', '${account.password}')" 
                                class="text-secondary hover:text-secondary/80 text-sm mr-2 copy-btn">
                            <i class="fa fa-copy"></i>
                        </button>
                        <button onclick="deleteAccount(${account.id})" 
                                class="text-red-500 hover:text-red-700 text-sm copy-btn">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;
                
                resultsTable.appendChild(row);
            });
            
            deleteAllBtn.disabled = registeredAccounts.length === 0;
        }

        // 过滤结果
        function filterResults() {
            updateResultsTable();
        }

        // 获取过滤后的账号
        function getFilteredAccounts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filterSelect').value;
            
            return registeredAccounts.filter(account => {
                const matchesSearch = account.email.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === 'all' || account.status === filterStatus;
                return matchesSearch && matchesFilter;
            });
        }

        // 导出结果
        function exportResults() {
            const successAccounts = registeredAccounts.filter(account => account.status === 'success');
            
            if (successAccounts.length === 0) {
                showError('没有成功注册的账号可导出');
                return;
            }
            
            try {
                let csvContent = "邮箱地址,密码,注册时间\n";
                
                successAccounts.forEach(account => {
                    // 导出时显示完整密码
                    csvContent += `${account.email},${account.password},${account.timestamp}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `邮箱注册结果_${new Date().toLocaleDateString()}.csv`);
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log('系统', `导出了 ${successAccounts.length} 个成功注册的账号`);
                showToast('导出成功！');
                
            } catch (error) {
                console.error('导出失败:', error);
                showError('导出失败，请重试');
                log('错误', `导出失败: ${error.message}`);
            }
        }

        // 清空结果
        function clearResults() {
            if (confirm('确定要清空所有注册记录吗？此操作不可撤销！')) {
                registeredAccounts = [];
                document.getElementById('recentResults').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fa fa-inbox text-4xl mb-2 opacity-50"></i>
                        <p class="text-sm">暂无注册记录</p>
                    </div>
                `;
                updateDashboard();
                updateResultsTable();
                updateButtonStates();
                saveData();
                log('系统', '清空了所有注册记录');
            }
        }

        // 重置表单
        function resetForm() {
            document.getElementById('registerCount').value = 5;
            document.getElementById('usernamePrefix').value = '';
            document.getElementById('usernameLength').value = '6';
            document.getElementById('generationMode').value = 'random';
            document.getElementById('numberMode').value = 'random';
            document.getElementById('numberLength').value = '3';
            document.getElementById('patternType').value = 'student_id';
            document.getElementById('startValue').value = '1001';
            document.getElementById('roleName').value = '';
            
            // 重置用户名字符类型选择
            document.getElementById('includeUsernameUppercase').checked = true;
            document.getElementById('includeUsernameLowercase').checked = true;
            document.getElementById('includeUsernameNumbers').checked = true;
            document.getElementById('includeUsernameSymbols').checked = false;
            
            // 重置密码字符类型选择
            document.getElementById('includeUppercase').checked = true;
            document.getElementById('includeLowercase').checked = true;
            document.getElementById('includeNumbers').checked = true;
            document.getElementById('includeSymbols').checked = false;
            document.getElementById('passwordLength').value = 10;
            
            updatePatternOptions();
            updateProgress(0, 0);
            updateStatusMessage('请先配置API并生成Token');
            
            log('系统', '表单已重置');
        }

        // 删除单个账号记录
        function deleteAccount(accountId) {
            if (confirm('确定要删除这条记录吗？')) {
                const index = registeredAccounts.findIndex(account => account.id === accountId);
                if (index !== -1) {
                    const deletedAccount = registeredAccounts.splice(index, 1)[0];
                    updateDashboard();
                    updateResultsTable();
                    updateButtonStates();
                    saveData();
                    log('系统', `删除了账号记录: ${deletedAccount.email}`);
                }
            }
        }

        // 确认删除全部记录
        function confirmDeleteAll() {
            if (registeredAccounts.length === 0) {
                showToast('没有记录可删除');
                return;
            }
            
            showModal('confirmDeleteModal');
        }

        // 删除全部记录
        function deleteAllRecords() {
            registeredAccounts = [];
            document.getElementById('recentResults').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fa fa-inbox text-4xl mb-2 opacity-50"></i>
                    <p class="text-sm">暂无注册记录</p>
                </div>
            `;
            updateDashboard();
            updateResultsTable();
            updateButtonStates();
            saveData();
            hideModal('confirmDeleteModal');
            log('系统', '已删除所有注册记录');
            showToast('所有记录已删除');
        }

        // 更新按钮状态
        function updateButtonStates() {
            const hasResults = registeredAccounts.length > 0;
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');
            const startRegisterBtn = document.getElementById('startRegisterBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            
            if (exportBtn) exportBtn.disabled = !hasResults;
            if (clearBtn) clearBtn.disabled = !hasResults;
            if (startRegisterBtn) startRegisterBtn.disabled = isRegistering;
            if (deleteAllBtn) deleteAllBtn.disabled = !hasResults;
        }

        // 复制文本
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制');
            });
        }

        // 复制账号信息
        function copyAccountInfo(email, password) {
            const info = `邮箱: ${email}\n密码: ${password}`;
            copyText(info);
        }

        // 显示加载模态框
        function showLoading(message = '请稍候...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.add('show');
            updateLoadingProgress(0);
        }

        // 显示成功模态框
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('show');
        }

        // 显示错误模态框
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.add('show');
        }

        // 显示模态框
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        // 隐藏模态框
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // 隐藏所有模态框
        function hideAllModals() {
            const modals = ['loadingModal', 'successModal', 'errorModal', 'tokenHistoryModal', 'confirmDeleteModal', 'helpModal'];
            modals.forEach(modalId => hideModal(modalId));
        }

        // 显示Toast通知
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 记录日志
        function log(type, message) {
            const logsContainer = document.getElementById('systemLogs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry flex items-start space-x-2';
            logEntry.innerHTML = `
                <span class="text-gray-400">[${new Date().toLocaleTimeString()}]</span>
                <span class="text-gray-600">${message}</span>
            `;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            // 限制日志数量
            while (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
            
            // 滚动到底部
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);

        // 错误处理
        window.addEventListener('error', (event) => {
            console.error('JavaScript错误:', event.error);
            showError('发生未知错误，请刷新页面重试');
            log('错误', `JavaScript错误: ${event.error.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的Promise拒绝:', event.reason);
            showError('发生未知错误，请重试');
            log('错误', `Promise拒绝: ${event.reason.message}`);
        });
    </script>
</body>
</html>
